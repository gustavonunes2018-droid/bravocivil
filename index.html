<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planner PRO v17 - Mobile & Equipamentos</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #2c3e50; --accent: #0984e3; --bg: #f0f2f5; --white: #ffffff; 
            --danger: #ff4757; --success: #2ed573; --warning: #ffa502; --text: #2f3542;
            --equip: #ff6b81; /* Cor para equipamentos */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); }
        
        /* --- LAYOUT RESPONSIVO --- */
        
        /* Desktop (Padrão) */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; z-index: 20; transition: 0.3s; }
        main { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; position: relative; }
        .bottom-nav { display: none; } /* Escondido no Desktop */

        /* Mobile (Telas menores que 768px) */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { display: none; } /* Esconde sidebar */
            main { padding: 15px; padding-bottom: 80px; /* Espaço para menu inferior */ }
            
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
                background: var(--white); box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                justify-content: space-around; align-items: center; z-index: 1000;
            }
            .nav-item {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                color: #a4b0be; font-size: 0.7rem; flex: 1; height: 100%; text-decoration: none;
            }
            .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
            .nav-item.active { color: var(--accent); border-top: 3px solid var(--accent); }
            
            /* Ajustes de Grid para Mobile */
            .form-row { flex-direction: column; gap: 10px !important; }
            .kpi-row { grid-template-columns: 1fr 1fr !important; }
            .team-grid { grid-template-columns: 1fr !important; }
            
            h2 { font-size: 1.2rem; }
            .btn { width: 100%; justify-content: center; padding: 15px; }
        }

        /* --- ESTILOS GERAIS --- */
        .brand { padding: 20px; font-weight: 800; font-size: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .save-indicator { font-size: 0.7rem; color: var(--success); opacity: 0; transition: opacity 0.5s; }

        /* Menu Lateral (Desktop) */
        .nav-btn { padding: 12px 20px; cursor: pointer; color: #dfe6e9; display: flex; gap: 10px; align-items: center; transition: 0.2s; }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.1); color: white; border-left: 4px solid var(--accent); }
        .nav-category { padding: 20px 20px 5px; font-size: 0.7rem; text-transform: uppercase; color: #b2bec3; font-weight: bold; }

        /* Cards e Paineis */
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #f1f2f6; padding-bottom: 10px; margin-bottom: 20px; }

        /* Forms */
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; width: 100%; }
        label { display: block; font-size: 0.8rem; color: #747d8c; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ced6e0; border-radius: 8px; font-size: 1rem; background: #fff; appearance: none; }
        input:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(9, 132, 227, 0.1); }

        /* Botões */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: var(--accent); color: white; display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); color: #2f3542; }

        /* Equipamentos vs Pessoas Tags */
        .type-tag { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .tag-human { background: #dfe4ea; color: #2f3542; }
        .tag-equip { background: #ff6b81; color: white; } /* Vermelho suave para máquinas */

        /* Equipes Cards */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .team-card { background: white; border: 1px solid #dfe6e9; border-radius: 10px; padding: 15px; border-left: 5px solid var(--accent); position: relative; }
        .member-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; margin: 2px; border: 1px solid #f1f2f6; }
        
        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-box { background: white; padding: 15px; border-radius: 10px; text-align: center; border-bottom: 3px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .kpi-val { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .kpi-lbl { font-size: 0.7rem; text-transform: uppercase; color: #747d8c; }

        /* Tasks Visual */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
        .status-ok { border-left-color: var(--success); }
        .status-late { border-left-color: var(--danger); }
        
        .edit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .edit-modal { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<aside>
    <div class="brand">
        <span><i class="fas fa-hammer"></i> PLANNER v17</span>
        <div class="save-indicator" id="save-status-desk"><i class="fas fa-check"></i></div>
    </div>
    <div class="nav-category">Geral</div>
    <div class="nav-btn active" onclick="nav('dash')"><i class="fas fa-chart-pie"></i> Dashboard</div>
    <div class="nav-btn" onclick="nav('schedule')"><i class="fas fa-calendar-alt"></i> Cronograma</div>
    <div class="nav-category">Recursos</div>
    <div class="nav-btn" onclick="nav('teams')"><i class="fas fa-users-cog"></i> Equipes</div>
    <div class="nav-btn" onclick="nav('resources')"><i class="fas fa-truck-pickup"></i> Recursos (Cargos/Eqp)</div>
    <div class="nav-btn" onclick="nav('services')"><i class="fas fa-cubes"></i> Serviços</div>
    <div style="margin-top:auto; padding:20px;">
        <button class="btn btn-danger" style="width:100%" onclick="resetData()">Resetar</button>
    </div>
</aside>

<nav class="bottom-nav">
    <a href="#" class="nav-item active" onclick="nav('dash', this)"><i class="fas fa-chart-pie"></i>Dash</a>
    <a href="#" class="nav-item" onclick="nav('schedule', this)"><i class="fas fa-calendar-alt"></i>Crono</a>
    <a href="#" class="nav-item" onclick="nav('teams', this)"><i class="fas fa-users"></i>Equipes</a>
    <a href="#" class="nav-item" onclick="nav('resources', this)"><i class="fas fa-truck"></i>Recursos</a>
    <a href="#" class="nav-item" onclick="nav('services', this)"><i class="fas fa-cubes"></i>Serviços</a>
</nav>

<main>
    <div id="dash" class="screen active">
        <h2>Dashboard</h2>
        <div class="kpi-row">
            <div class="kpi-box" style="border-color:var(--primary)"><div class="kpi-val" id="kpi-cost">0</div><div class="kpi-lbl">Custo Total</div></div>
            <div class="kpi-box" style="border-color:var(--equip)"><div class="kpi-val" id="kpi-equip">0</div><div class="kpi-lbl">Custo Equip.</div></div>
            <div class="kpi-box" style="border-color:var(--warning)"><div class="kpi-val" id="kpi-peak">0</div><div class="kpi-lbl">Pico Pessoas</div></div>
            <div class="kpi-box" style="border-color:var(--success)"><div class="kpi-val" id="kpi-tasks">0</div><div class="kpi-lbl">Tarefas</div></div>
        </div>
        <div class="card">
            <h3><i class="fas fa-money-bill-wave"></i> Custo: Pessoas vs Equipamentos</h3>
            <div id="chart-finance" style="height:350px;"></div>
        </div>
        <div class="card">
            <h3><i class="fas fa-users"></i> Histograma de Equipes</h3>
            <div id="chart-manpower" style="height:300px;"></div>
        </div>
        <button class="btn" onclick="calcDash()">Atualizar Gráficos</button>
    </div>

    <div id="resources" class="screen">
        <div class="card">
            <h2>Cargos & Equipamentos</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Nome (Ex: Pedreiro, Retroescavadeira)</label>
                    <input type="text" id="res-name">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="res-cat">
                        <option value="human">Mão de Obra (Humano)</option>
                        <option value="equip">Equipamento (Máquina)</option>
                        <option value="adm">Administrativo</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Custo Mensal (R$)</label>
                    <input type="number" id="res-cost" placeholder="0.00">
                </div>
                <div class="form-group" style="flex:0">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="addRes()"><i class="fas fa-plus"></i> Adicionar</button>
                </div>
            </div>
            
            <h3>Lista de Recursos</h3>
            <div id="res-list" style="display:grid; gap:10px;"></div>
        </div>
    </div>

    <div id="teams" class="screen">
        <div class="card">
            <h2>Composição de Equipes</h2>
            <div class="form-row">
                <div class="form-group"><label>Nova Equipe</label><input type="text" id="team-name" placeholder="Nome da Equipe"></div>
                <div class="form-group" style="flex:0"><label>&nbsp;</label><button class="btn" onclick="createTeam()">Criar</button></div>
            </div>
            <div id="teams-grid" class="team-grid"></div>
        </div>
    </div>

    <div id="edit-overlay" class="edit-overlay">
        <div class="edit-modal">
            <h3 style="margin-top:0">Editar Equipe</h3>
            <input type="hidden" id="edit-id">
            <div class="form-row">
                <div class="form-group"><label>Nome</label><input id="edit-name-input"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Adicionar Recurso</label>
                    <select id="edit-res-sel"></select>
                </div>
                <div class="form-group" style="flex:0.4">
                    <label>Qtd</label>
                    <input type="number" id="edit-res-qty" value="1">
                </div>
                <div class="form-group" style="flex:0">
                    <label>&nbsp;</label>
                    <button class="btn btn-warning" onclick="addMemEdit()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div id="edit-list" style="margin-bottom:20px; background:#f5f6fa; padding:10px; border-radius:8px;"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-success" style="flex:1" onclick="saveEdit()">Salvar</button>
                <button class="btn btn-danger" style="flex:1" onclick="closeEdit()">Fechar</button>
            </div>
        </div>
    </div>

    <div id="schedule" class="screen">
        <div class="card">
            <h2>Cronograma</h2>
            <div class="form-row">
                <div class="form-group"><label>Descrição</label><input type="text" id="t-desc"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Serviço</label><select id="t-svc"></select></div>
                <div class="form-group"><label>Equipe</label><select id="t-team"></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Início</label><input type="date" id="t-start"></div>
                <div class="form-group"><label>Fim</label><input type="date" id="t-end"></div>
            </div>
            <button class="btn" style="width:100%" onclick="addTask()"><i class="fas fa-plus"></i> Adicionar Tarefa</button>
            
            <h3 style="margin-top:20px">Lista de Tarefas</h3>
            <div id="task-list" class="task-list"></div>
        </div>
    </div>

    <div id="services" class="screen">
        <div class="card">
            <h2>Serviços</h2>
            <div class="form-row">
                <div class="form-group"><label>Nome</label><input type="text" id="svc-name"></div>
                <div class="form-group"><label>Unidade</label><input type="text" id="svc-unit"></div>
                <div class="form-group" style="flex:0"><label>&nbsp;</label><button class="btn" onclick="addSvc()">Add</button></div>
            </div>
            <div id="svc-list"></div>
        </div>
    </div>

</main>

<script>
    // --- DADOS ---
    let db = {
        // Categoria adicionada ao recurso: 'human' ou 'equip' ou 'adm'
        res: JSON.parse(localStorage.getItem('p17_res')) || [
            {id:1, name:'Pedreiro', cat:'human', cost:3500},
            {id:2, name:'Retroescavadeira', cat:'equip', cost:15000},
            {id:3, name:'Engenheiro', cat:'adm', cost:12000}
        ],
        teams: JSON.parse(localStorage.getItem('p17_teams')) || [
            {id:1, name:'Eq. Terraplanagem', members:[{resId:1, qty:1}, {resId:2, qty:1}]} // 1 Pedreiro + 1 Retro
        ],
        svc: JSON.parse(localStorage.getItem('p17_svc')) || [{id:1, name:'Escavação', unit:'m³'}],
        tasks: JSON.parse(localStorage.getItem('p17_tasks')) || []
    };

    function save() {
        localStorage.setItem('p17_res', JSON.stringify(db.res));
        localStorage.setItem('p17_teams', JSON.stringify(db.teams));
        localStorage.setItem('p17_svc', JSON.stringify(db.svc));
        localStorage.setItem('p17_tasks', JSON.stringify(db.tasks));
        document.getElementById('save-status-desk').style.opacity = '1';
        setTimeout(() => document.getElementById('save-status-desk').style.opacity='0', 1000);
        renderAll();
    }
    
    function resetData() { if(confirm("Apagar tudo?")) { localStorage.clear(); location.reload(); } }

    function nav(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // Atualiza botões do mobile e desktop
        document.querySelectorAll('.nav-btn, .nav-item').forEach(b => b.classList.remove('active'));
        if(el) el.classList.add('active');
        
        if(id === 'dash') setTimeout(calcDash, 200);
        updateSelects();
    }

    // --- RECURSOS (PESSOAS & MAQUINAS) ---
    function addRes() {
        const name = document.getElementById('res-name').value;
        const cat = document.getElementById('res-cat').value;
        const cost = parseFloat(document.getElementById('res-cost').value);
        if(name && cost) {
            db.res.push({id:Date.now(), name, cat, cost});
            save();
            document.getElementById('res-name').value='';
            document.getElementById('res-cost').value='';
        }
    }

    function renderRes() {
        const list = document.getElementById('res-list');
        list.innerHTML = db.res.map(r => {
            let icon = r.cat==='equip' ? '<i class="fas fa-truck-pickup"></i>' : (r.cat==='adm'?'<i class="fas fa-user-tie"></i>':'<i class="fas fa-hard-hat"></i>');
            let color = r.cat==='equip' ? 'border-left:4px solid #ff6b81' : 'border-left:4px solid #747d8c';
            return `
            <div style="background:white; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; ${color}; border:1px solid #eee;">
                <div>${icon} <strong>${r.name}</strong></div>
                <div>R$ ${r.cost.toLocaleString('pt-BR')}</div>
                <button class="btn btn-danger" style="padding:5px 10px" onclick="delRes(${r.id})"><i class="fas fa-trash"></i></button>
            </div>`;
        }).join('');
    }
    function delRes(id) { db.res = db.res.filter(r => r.id !== id); save(); }

    // --- EQUIPES (COMPOSTAS) ---
    function createTeam() {
        const name = document.getElementById('team-name').value;
        if(name) { db.teams.push({id:Date.now(), name, members:[]}); save(); document.getElementById('team-name').value=''; }
    }

    function renderTeams() {
        document.getElementById('teams-grid').innerHTML = db.teams.map(t => {
            let totalCost = 0;
            let membersHtml = t.members.map(m => {
                let r = db.res.find(x => x.id == m.resId);
                if(!r) return '';
                totalCost += r.cost * m.qty;
                let bg = r.cat === 'equip' ? 'background:#ffecf0; color:#ff6b81; border-color:#ff6b81' : 'background:#f1f2f6; color:#333';
                let icon = r.cat === 'equip' ? '<i class="fas fa-truck"></i>' : '<i class="fas fa-user"></i>';
                return `<span class="member-badge" style="${bg}">${m.qty}x ${icon} ${r.name}</span>`;
            }).join('');
            
            return `
            <div class="team-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong>${t.name}</strong>
                    <button class="btn btn-warning" style="padding:4px 8px; font-size:0.7rem" onclick="openEdit(${t.id})"><i class="fas fa-edit"></i></button>
                </div>
                <div style="margin-bottom:10px;">${membersHtml || '<small>Vazio</small>'}</div>
                <div style="border-top:1px solid #eee; padding-top:5px; font-weight:bold; color:var(--success)">
                    Custo: R$ ${totalCost.toLocaleString('pt-BR')} /mês
                </div>
            </div>`;
        }).join('');
    }

    // Modal Edit Team
    function openEdit(id) {
        document.getElementById('edit-overlay').style.display = 'flex';
        let t = db.teams.find(x => x.id == id);
        document.getElementById('edit-id').value = t.id;
        document.getElementById('edit-name-input').value = t.name;
        updateEditList(t);
        // Preenche select com ícones
        document.getElementById('edit-res-sel').innerHTML = db.res.map(r => {
            let type = r.cat==='equip' ? '[MAQ]' : '[PES]';
            return `<option value="${r.id}">${type} ${r.name}</option>`;
        }).join('');
    }
    
    function closeEdit() { document.getElementById('edit-overlay').style.display = 'none'; }
    
    function updateEditList(t) {
        document.getElementById('edit-list').innerHTML = t.members.map((m, i) => {
            let r = db.res.find(x => x.id == m.resId);
            return `<div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #e1e1e1; padding-bottom:5px;">
                <span>${m.qty}x ${r?r.name:'?'}</span>
                <i class="fas fa-times" style="color:red; cursor:pointer" onclick="remMem(${i})"></i>
            </div>`;
        }).join('');
    }
    
    function addMemEdit() {
        let t = db.teams.find(x => x.id == document.getElementById('edit-id').value);
        let rid = parseInt(document.getElementById('edit-res-sel').value);
        let qty = parseInt(document.getElementById('edit-res-qty').value);
        t.members.push({resId: rid, qty: qty});
        updateEditList(t);
    }
    function remMem(i) {
        let t = db.teams.find(x => x.id == document.getElementById('edit-id').value);
        t.members.splice(i, 1);
        updateEditList(t);
    }
    function saveEdit() {
        let t = db.teams.find(x => x.id == document.getElementById('edit-id').value);
        t.name = document.getElementById('edit-name-input').value;
        save(); closeEdit();
    }

    // --- CRONOGRAMA ---
    function addTask() {
        const desc = document.getElementById('t-desc').value;
        const start = document.getElementById('t-start').value;
        const end = document.getElementById('t-end').value;
        if(desc && start && end) {
            db.tasks.push({
                id:Date.now(), desc, 
                svcId:document.getElementById('t-svc').value, 
                teamId:document.getElementById('t-team').value,
                start, end
            });
            save(); document.getElementById('t-desc').value='';
        }
    }
    function delTask(id) { db.tasks = db.tasks.filter(t => t.id!==id); save(); }
    function renderTasks() {
        document.getElementById('task-list').innerHTML = db.tasks.map(t => {
            let tm = db.teams.find(x=>x.id==t.teamId);
            return `<div class="task-item">
                <div><strong>${t.desc}</strong><br><small>${tm?tm.name:'?'}</small></div>
                <div style="font-size:0.8rem">${t.start.slice(5)} a ${t.end.slice(5)}</div>
                <button class="btn btn-danger" style="padding:5px" onclick="delTask(${t.id})"><i class="fas fa-trash"></i></button>
            </div>`;
        }).join('');
    }

    // --- SERVIÇOS ---
    function addSvc() { db.svc.push({id:Date.now(), name:document.getElementById('svc-name').value, unit:document.getElementById('svc-unit').value}); save(); }
    function renderSvc() { document.getElementById('svc-list').innerHTML=db.svc.map(s=>`<div style="background:white;padding:10px;margin-bottom:5px;border-radius:4px">${s.name} (${s.unit})</div>`).join(''); }

    // --- DASHBOARD ---
    function calcDash() {
        if(db.tasks.length===0) return;
        
        let dMin=new Date(db.tasks[0].start); let dMax=new Date(db.tasks[0].end);
        db.tasks.forEach(t=>{ if(new Date(t.start)<dMin) dMin=new Date(t.start); if(new Date(t.end)>dMax) dMax=new Date(t.end); });
        let months=[]; let cur=new Date(dMin.getFullYear(), dMin.getMonth(), 1); let end=new Date(dMax.getFullYear(), dMax.getMonth()+1, 0);
        while(cur<=end){ months.push(new Date(cur)); cur.setMonth(cur.getMonth()+1); }
        let labels = months.map(d=>d.toLocaleString('pt-BR',{month:'short',year:'2-digit'}));
        
        // Arrays de dados
        let laborCost = new Array(months.length).fill(0);
        let equipCost = new Array(months.length).fill(0);
        let teamStack = {}; 
        
        db.tasks.forEach(t => {
            let tm = db.teams.find(x=>x.id==t.teamId);
            if(!tm) return;
            if(!teamStack[tm.name]) teamStack[tm.name] = new Array(months.length).fill(0);

            // Calcula custo mensal da equipe SEPARANDO MO de EQUIP
            let moMonth = 0;
            let eqMonth = 0;
            let peopleCount = 0;

            tm.members.forEach(m => {
                let r = db.res.find(x=>x.id==m.resId);
                if(r) {
                    if(r.cat === 'equip') eqMonth += r.cost * m.qty;
                    else { moMonth += r.cost * m.qty; peopleCount += m.qty; }
                }
            });

            // Distribui nos meses
            let tS=new Date(t.start); let tE=new Date(t.end);
            months.forEach((mDate, i) => {
                let mS=new Date(mDate.getFullYear(), mDate.getMonth(), 1);
                let mE=new Date(mDate.getFullYear(), mDate.getMonth()+1, 0);
                if(tS<=mE && tE>=mS) {
                    laborCost[i] += moMonth;
                    equipCost[i] += eqMonth;
                    teamStack[tm.name][i] += peopleCount;
                }
            });
        });

        // Totais
        let totLab = laborCost.reduce((a,b)=>a+b,0);
        let totEq = equipCost.reduce((a,b)=>a+b,0);
        
        document.getElementById('kpi-cost').innerText = "R$ " + (totLab+totEq).toLocaleString('pt-BR',{maximumFractionDigits:0, notations:'compact'});
        document.getElementById('kpi-equip').innerText = "R$ " + totEq.toLocaleString('pt-BR',{maximumFractionDigits:0, notations:'compact'});
        document.getElementById('kpi-tasks').innerText = db.tasks.length;

        // Gráfico Financeiro
        Plotly.newPlot('chart-finance', [
            {x:labels, y:laborCost, name:'Mão de Obra', type:'bar', marker:{color:'#2c3e50'}},
            {x:labels, y:equipCost, name:'Equipamentos', type:'bar', marker:{color:'#ff6b81'}}
        ], {barmode:'stack', margin:{t:30,l:30,r:30,b:30}, legend:{orientation:'h',y:-0.2}});

        // Gráfico MO
        let traces=[];
        for(let k in teamStack) traces.push({x:labels, y:teamStack[k], name:k, type:'bar'});
        Plotly.newPlot('chart-manpower', traces, {barmode:'stack', margin:{t:30,l:30,r:30,b:30}, legend:{orientation:'h',y:-0.2}});
    }

    function updateSelects(){
        const f=(id,l)=>document.getElementById(id).innerHTML='<option value="">...</option>'+l.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
        f('t-svc', db.svc); f('t-team', db.teams);
    }
    function renderAll(){ renderRes(); renderTeams(); renderTasks(); renderSvc(); updateSelects(); }

    renderAll();
    setTimeout(calcDash, 500);
</script>
</body>
</html>