<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bravo CIVIL - v145.3 (Links & Move)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        
        :root { --header-h: 50px; --row-h: 40px; }
        * { box-sizing: border-box; } 

        body { font-family: 'Inter', sans-serif; background: #f8fafc; overflow: hidden; margin: 0; }
        .page { display: none; width: 100vw; height: 100vh; position: absolute; background: #f8fafc; }
        .page.active { display: block; }
        
        .master-grid { display: flex; height: calc(100vh - 120px); background: white; border-top: 1px solid #cbd5e1; }
        
        #wrapper-table { width: 60%; overflow-y: auto; overflow-x: auto; border-right: 2px solid #cbd5e1; background: #fff; }
        #wrapper-table::-webkit-scrollbar { width: 6px; height: 6px; }
        #wrapper-table::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        table { width: 100%; border-collapse: collapse; border-spacing: 0; table-layout: fixed; font-size: 11px; }
        thead { height: var(--header-h); background: #f1f5f9; position: sticky; top: 0; z-index: 40; }
        th { height: var(--header-h); line-height: var(--header-h); padding: 0 8px; border-bottom: 1px solid #cbd5e1; border-right: 1px solid #e2e8f0; background: #f1f5f9; color: #475569; font-weight: 800; text-transform: uppercase; white-space: nowrap; overflow: hidden; }
        
        tr { height: var(--row-h); max-height: var(--row-h); transition: background-color 0.1s ease; }
        tr:hover { background-color: #f8fafc; }
        td { height: var(--row-h); max-height: var(--row-h); padding: 0; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; white-space: nowrap; overflow: hidden; vertical-align: middle; }
        
        .cell-actions { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; gap: 2px; }
        .cell-actions button { display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 4px; transition: background 0.2s; }
        .cell-actions button:hover { background-color: #f1f5f9; }

        .input-cell { background: transparent; width: 100%; outline: none; padding: 0 4px; font-size: 11px; border: 1px solid transparent; height: 100%; color: #334155; display: flex; align-items: center; }
        .input-cell:focus { border: 2px solid #3b82f6; background: #fff; color: #000; font-weight: bold; }
        
        .flatpickr-input { background: transparent; width: 100%; border: none; height: 100%; font-size: 11px; text-align: center; cursor: pointer; color: #334155; font-weight: 500; }
        .flatpickr-input:focus { outline: none; background: #f0f9ff; color: #000; font-weight: bold; }
        
        .group-row { background-color: #f8fafc; font-weight: 800; color: #0f172a; border-top: 1px solid #cbd5e1; }
        .root-row { background-color: #1e293b !important; color: #fff !important; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; }
        .root-row input { color: #fff !important; }
        .blocked-cell { color: #94a3b8; background: #f1f5f9; cursor: not-allowed; font-style: italic; display: flex; align-items: center; justify-content: center; height: 100%; }

        /* ESTILOS DE LINKAGEM VISUAL */
        body.linking-mode .master-grid { cursor: crosshair; }
        tr.row-linking-source { background-color: #dbeafe !important; border-left: 4px solid #2563eb; }
        tr.row-linking-hover:hover { background-color: #f0fdf4 !important; cursor: alias; }

        #wrapper-gantt { width: 40%; overflow-y: auto; overflow-x: auto; position: relative; background: #fff; }
        .gantt .grid-header { height: var(--header-h); fill: #f8fafc; stroke: #e2e8f0; }
        .gantt .grid-row { height: var(--row-h); fill: white; stroke: #f1f5f9; } 
        .gantt-container { height: auto; overflow: visible; }
        
        .gantt .bar { z-index: 20; height: 18px !important; rx: 3; transform: translateY(-2px); fill: #3b82f6 !important; }
        .gantt .bar-progress { fill: #15803d !important; opacity: 1; height: 8px !important; transform: translateY(3px); }
        .gantt .bar-group { fill: #334155 !important; opacity: 1; height: 10px !important; transform: translateY(2px) !important; }
        
        .baseline-bar { fill: #94a3b8 !important; opacity: 0.6; height: 4px !important; pointer-events: none; z-index: 10; rx: 2; }
        .gantt .bar-risk-critical { stroke: #ef4444; stroke-width: 2px; }
        .gantt .bar-risk-high { stroke: #f97316; stroke-width: 2px; }
        .gantt .bar-invisible { opacity: 0; pointer-events: none; }
        .scroll-spacer { height: 200px; width: 100%; }

        #eap-viewport { width: 100%; height: 100%; overflow: hidden; position: relative; background-color: #f8fafc; background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px); background-size: 24px 24px; cursor: default; }
        #eap-canvas { transform-origin: 0 0; position: absolute; top: 0; left: 0; w-full; h-full; }
        .eap-node { position: absolute; background: white; border: 1px solid #cbd5e1; border-left: 4px solid #3b82f6; padding: 0; border-radius: 6px; width: 180px; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .eap-header { padding: 6px 10px; border-bottom: 1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; background: #f8fafc; cursor: grab; }
        .eap-header:active { cursor: grabbing; } 
        body.linking-cursor #eap-viewport, body.linking-cursor .eap-node { cursor: crosshair !important; }
        .eap-node.linking-mode { border: 2px dashed #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); transform: scale(1.02); transition: 0.2s; }

        .modal { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.6); backdrop-filter:blur(2px); z-index:100; align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; overflow: visible; height: auto; }
            .page { position: relative; height: auto; overflow: visible; }
            nav, header, .no-print, button, .scroll-spacer { display: none !important; }
            #wrapper-table, #wrapper-gantt { width: 100%; overflow: visible; border: none; }
            .master-grid { display: block; height: auto; border: none; }
            #v-dash, #v-site { display: block !important; height: auto; overflow: visible; page-break-after: always; }
            #v-main { display: block !important; height: auto; overflow: visible; }
            table { font-size: 10px; width: 100%; border: 1px solid #ccc; }
            th, td { border: 1px solid #eee; height: 30px; }
            .root-row { background-color: #ddd !important; color: #000 !important; -webkit-print-color-adjust: exact; }
            #gantt-box svg { overflow: visible; width: 100%; }
        }
    </style>
</head>
<body>

    <div id="page-login" class="page active flex items-center justify-center bg-slate-900">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-4xl font-black italic mb-2 text-slate-900">Bravo<span class="text-blue-600">CIVIL</span></h1>
            <p class="text-xs text-slate-400 mb-6 font-bold uppercase">Versão 145.3 (Link & Move)</p>
            <input type="text" id="log-u" class="w-full border-2 p-4 rounded-2xl mb-4 text-sm" placeholder="Usuário (admin)">
            <input type="password" id="log-p" class="w-full border-2 p-4 rounded-2xl mb-6 text-sm" placeholder="Senha (123)">
            <button onclick="auth.login()" id="btn-login" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-xs hover:bg-blue-700 transition">Acessar Sistema</button>
            <p class="mt-4 text-[10px] text-slate-400">Use <strong>admin / 123</strong> para acesso local.</p>
        </div>
    </div>

    <div id="page-manager" class="page">
        <nav class="bg-white border-b px-8 py-4 flex justify-between items-center">
            <h1 class="text-xl font-black italic">Bravo<span class="text-blue-600">CIVIL</span></h1>
            <div class="flex gap-3">
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="projectManager.importFile(this)">
                <button onclick="userManager.open()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-bold text-[10px] uppercase">Equipe</button>
                <button onclick="document.getElementById('import-file').click()" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-[10px] uppercase flex items-center gap-2"><i data-lucide="upload" class="w-3"></i> Importar</button>
                <button onclick="projectManager.openCreateSelection()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-black text-[10px] uppercase">+ Novo Projeto</button>
                <button onclick="location.reload()" class="text-slate-400 p-2"><i data-lucide="log-out"></i></button>
            </div>
        </nav>
        <div id="grid-projects" class="max-w-6xl mx-auto p-12 grid grid-cols-1 md:grid-cols-3 gap-8"></div>
    </div>

    <div id="page-editor" class="page">
        <header class="h-16 bg-slate-900 text-white px-6 flex justify-between items-center z-50 shadow-md">
            <div class="flex items-center gap-4">
                <button onclick="editor.close()" class="p-2 hover:bg-slate-800 rounded-lg"><i data-lucide="chevron-left"></i></button>
                <h2 id="edit-name" class="font-black italic uppercase text-[10px] tracking-wider">OBRA</h2>
            </div>
            <div class="flex bg-slate-800 p-1 rounded-xl gap-1">
                <button onclick="editor.switchView('eap')" id="btn-v-eap" class="view-btn px-4 py-2 text-[9px] font-black uppercase rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition">EAP</button>
                <button onclick="editor.switchView('main')" id="btn-v-main" class="view-btn px-4 py-2 text-[9px] font-black uppercase rounded-lg bg-blue-600 text-white shadow">Cronograma</button>
                <button onclick="editor.switchView('site')" id="btn-v-site" class="view-btn px-4 py-2 text-[9px] font-black uppercase rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition flex items-center gap-1"><i data-lucide="hard-hat" class="w-3"></i> VISÃO OBRA</button>
                <button onclick="editor.switchView('kanban')" id="btn-v-kanban" class="view-btn px-4 py-2 text-[9px] font-black uppercase rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition">Kanban</button>
                <button onclick="editor.switchView('bal')" id="btn-v-bal" class="view-btn px-4 py-2 text-[9px] font-black uppercase rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition">L. Balanço</button>
                <button onclick="editor.switchView('cash')" id="btn-v-cash" class="view-btn px-4 py-2 text-[9px] font-black uppercase rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition">Financeiro</button>
                <button onclick="editor.switchView('dash')" id="btn-v-dash" class="view-btn px-4 py-2 text-[9px] font-black uppercase rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition">Dash AI</button>
            </div>
            <div class="flex gap-2">
                <button onclick="editor.exportCSV()" class="bg-green-600 text-white p-2 rounded-lg flex items-center gap-2 px-3 hover:bg-green-500 font-bold text-[10px] uppercase" title="Exportar CSV/Excel"><i data-lucide="sheet" class="w-4"></i> Excel</button>
                <button onclick="editor.printPresentation()" class="bg-pink-600 text-white p-2 rounded-lg flex items-center gap-2 px-3 hover:bg-pink-500 font-bold text-[10px] uppercase" title="Exportar PDF"><i data-lucide="printer" class="w-4"></i> PDF</button>
                <button onclick="editor.openSnapshots()" class="bg-indigo-600 text-white p-2 rounded-lg flex items-center gap-2 px-3 hover:bg-indigo-500 font-bold text-[10px] uppercase"><i data-lucide="history" class="w-4"></i> Versões</button>
                <button onclick="editor.openConfig()" class="p-2 bg-slate-800 rounded-lg text-white hover:bg-slate-700"><i data-lucide="settings" class="w-4"></i></button>
            </div>
        </header>

        <main id="editor-content" class="bg-white h-[calc(100vh-64px)] overflow-hidden">
            <div id="v-main" class="view h-full flex flex-col">
                <div class="bg-white border-b p-2 flex justify-between items-center h-[50px] flex-shrink-0 no-print">
                    <div class="flex gap-2 items-center">
                        <button onclick="editor.addGroup()" class="bg-slate-800 text-white text-[9px] px-3 py-1.5 rounded font-black uppercase hover:bg-slate-700 flex gap-1 items-center shadow"><i data-lucide="folder-plus" class="w-3"></i> + Grupo</button>
                        <div class="h-6 w-[1px] bg-slate-200 mx-2"></div>
                        
                        <button onclick="editor.toggleLinkMode()" id="btn-link-mode" class="bg-slate-200 text-slate-600 text-[9px] px-3 py-1.5 rounded font-black uppercase flex gap-1 items-center hover:bg-slate-300 transition border border-slate-300 shadow-sm">
                            <i data-lucide="link" class="w-3"></i> <span>LIGAR TAREFAS</span>
                        </button>
                        
                        <div class="h-6 w-[1px] bg-slate-200 mx-2"></div>
                        
                        <button onclick="editor.toggleAllGroups(true)" class="bg-slate-100 text-slate-600 text-[9px] px-3 py-1.5 rounded font-black uppercase">Recolher</button>
                        <button onclick="editor.toggleAllGroups(false)" class="bg-slate-100 text-slate-600 text-[9px] px-3 py-1.5 rounded font-black uppercase">Expandir</button>
                        <div class="h-6 w-[1px] bg-slate-200 mx-2"></div>
                        <button onclick="editor.toggleMode()" class="bg-blue-500 text-white text-[9px] px-3 py-1.5 rounded font-black uppercase flex gap-1 items-center hover:bg-blue-600 shadow-sm transition"><i data-lucide="activity" class="w-3"></i> <span id="mode-label">MODO PADRÃO</span></button>
                        
                        <div id="measurement-controls" class="hidden flex gap-2 ml-2 animate-fade-in bg-slate-100 p-1 rounded-lg border border-slate-200">
                            <button onclick="measurementEngine.saveSnapshot()" class="bg-green-600 text-white text-[9px] px-3 py-1.5 rounded font-black uppercase flex gap-1 items-center hover:bg-green-700 shadow"><i data-lucide="save" class="w-3"></i> FECHAR MEDIÇÃO</button>
                            <button onclick="measurementEngine.viewHistory()" class="bg-white text-slate-700 border text-[9px] px-3 py-1.5 rounded font-black uppercase hover:bg-slate-50 flex gap-1 items-center"><i data-lucide="list" class="w-3"></i> HISTÓRICO</button>
                        </div>
                        <button onclick="editor.recalculateSchedule()" class="bg-orange-500 text-white text-[9px] px-3 py-1.5 rounded font-black uppercase flex gap-1 items-center hover:bg-orange-600 shadow-sm ml-2" title="Reprogramar saldo"><i data-lucide="refresh-cw" class="w-3"></i> RECALCULAR</button>
                    </div>
                    <div class="flex items-center gap-4 bg-slate-50 border px-3 py-1 rounded-lg">
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-blue-500 rounded"></div><span class="text-[9px] font-bold text-slate-600 uppercase">Planejado</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-2 bg-green-700 rounded"></div><span class="text-[9px] font-bold text-slate-600 uppercase">Executado</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-1 bg-slate-400 rounded"></div><span class="text-[9px] font-bold text-slate-600 uppercase">Baseline</span></div>
                    </div>
                    <div class="flex gap-1 bg-slate-100 p-1 rounded"><button onclick="editor.changeGanttMode('Day')" class="text-[9px] font-bold px-3 py-1 hover:bg-white rounded transition">Dia</button><button onclick="editor.changeGanttMode('Week')" class="text-[9px] font-bold px-3 py-1 hover:bg-white rounded transition">Sem</button><button onclick="editor.changeGanttMode('Month')" class="text-[9px] font-bold px-3 py-1 hover:bg-white rounded transition">Mês</button></div>
                </div>
                <div class="master-grid flex-grow overflow-hidden relative">
                    <div id="wrapper-table">
                        <table class="w-full">
                            <thead class="bg-slate-50 text-[9px] font-black uppercase text-slate-400 border-b">
                                <tr id="table-head-row"></tr>
                            </thead>
                            <tbody id="tbody"></tbody>
                        </table>
                        <div class="scroll-spacer"></div>
                    </div>
                    <div id="wrapper-gantt">
                        <div id="gantt-box" class="h-full w-full"></div>
                        <div class="scroll-spacer"></div>
                    </div>
                </div>
            </div>
            
            <div id="v-site" class="view hidden p-8 bg-slate-50 h-full overflow-y-auto">
                <div class="flex justify-between items-center mb-8 border-b pb-4">
                    <div>
                        <h2 class="text-3xl font-black italic text-slate-800 uppercase">Visão de Campo</h2>
                        <p class="text-xs text-slate-500 font-bold uppercase mt-1">Relatório de Status da Obra</p>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] uppercase font-bold text-slate-400">Data de Referência</div>
                        <div class="text-xl font-black text-slate-800" id="site-date"></div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-red-500 shadow-sm">
                        <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Itens Atrasados</div>
                        <div class="text-3xl font-black text-red-600" id="site-delay-count">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-blue-500 shadow-sm">
                        <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Previsto no Mês</div>
                        <div class="text-3xl font-black text-blue-600" id="site-month-count">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-green-500 shadow-sm">
                        <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Avanço Global</div>
                        <div class="text-3xl font-black text-green-600" id="site-global-prog">0%</div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border mb-8 overflow-hidden">
                    <div class="bg-red-50 p-4 border-b border-red-100 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i><h3 class="font-black text-red-700 uppercase text-xs">Itens em Atraso (Crítico)</h3></div>
                    <div class="p-0"><table class="w-full text-left text-xs"><thead class="bg-slate-50 text-slate-500 uppercase font-bold border-b"><tr><th class="p-3">Grupo / Serviço</th><th class="p-3">Pavimento (Item)</th><th class="p-3 text-center">Data Fim (Cronograma)</th><th class="p-3 text-center">Dias de Atraso</th><th class="p-3 text-center">Status Físico</th></tr></thead><tbody id="site-delay-table" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border mb-8 overflow-hidden">
                    <div class="bg-blue-50 p-4 border-b border-blue-100 flex items-center gap-2"><i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i><h3 class="font-black text-blue-700 uppercase text-xs">Planejamento do Mês Atual</h3></div>
                    <div class="p-0"><table class="w-full text-left text-xs"><thead class="bg-slate-50 text-slate-500 uppercase font-bold border-b"><tr><th class="p-3">Grupo / Serviço</th><th class="p-3">Pavimento (Item)</th><th class="p-3 text-center">Início</th><th class="p-3 text-center">Fim</th></tr></thead><tbody id="site-month-table" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
            </div>

            <div id="v-eap" class="view hidden h-full w-full relative overflow-hidden">
                <div class="absolute top-4 left-4 z-50 flex gap-2"><button onclick="editor.addEapNode()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg hover:bg-slate-800 transition">+ Balão</button><div class="bg-white flex rounded-xl shadow border"><button onclick="editor.zoom(0.1)" class="px-3 border-r hover:bg-slate-100"><i data-lucide="zoom-in" class="w-4"></i></button><button onclick="editor.zoom(-0.1)" class="px-3 border-r hover:bg-slate-100"><i data-lucide="zoom-out" class="w-4"></i></button><button onclick="editor.resetZoom()" class="px-3 text-[10px] font-bold hover:bg-slate-100">100%</button></div></div>
                <div id="eap-viewport"><div id="eap-canvas"><svg id="eap-svg" class="absolute inset-0 w-full h-full pointer-events-none z-10 overflow-visible"></svg><div id="eap-nodes-layer" class="absolute inset-0 z-20"></div></div></div>
            </div>

            <div id="v-kanban" class="view hidden p-8 bg-slate-100 h-full overflow-x-auto">
                <div class="flex gap-6 h-full">
                    <div class="bg-slate-200 p-4 rounded-xl min-w-[300px] flex flex-col h-full"><h4 class="font-black text-[10px] mb-4 uppercase">A Fazer <button onclick="editor.addKb('todo')" class="ml-2">+</button></h4><div id="kb-todo" class="space-y-3 overflow-y-auto flex-grow min-h-0"></div></div>
                    <div class="bg-blue-50 p-4 rounded-xl min-w-[300px] flex flex-col h-full"><h4 class="font-black text-[10px] mb-4 uppercase text-blue-600">Em Andamento <button onclick="editor.addKb('doing')" class="ml-2">+</button></h4><div id="kb-doing" class="space-y-3 overflow-y-auto flex-grow min-h-0"></div></div>
                    <div class="bg-green-50 p-4 rounded-xl min-w-[300px] flex flex-col h-full"><h4 class="font-black text-[10px] mb-4 uppercase text-green-600">Concluído <button onclick="editor.addKb('done')" class="ml-2">+</button></h4><div id="kb-done" class="space-y-3 overflow-y-auto flex-grow min-h-0"></div></div>
                </div>
            </div>

            <div id="v-dash" class="view hidden p-10 bg-white h-full overflow-y-auto"><div class="flex justify-between items-end mb-8"><h2 class="text-2xl font-black italic text-slate-800">Visão Estratégica</h2><span class="text-[10px] font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-full uppercase">IA v145.3</span></div><div class="ai-panel p-8 rounded-2xl shadow-sm mb-10 relative overflow-hidden"><h3 class="font-black text-blue-600 uppercase text-xs mb-4 flex items-center gap-2"><i data-lucide="sparkles" class="w-4"></i> Análise Narrativa da IA</h3><div id="ai-narrative-content" class="text-slate-700 text-sm leading-relaxed font-medium space-y-2">Calculando...</div></div><div class="grid grid-cols-4 gap-6 mb-10" id="dash-kpi"></div><div class="grid grid-cols-2 gap-8"><div class="border p-6 rounded-[30px] bg-slate-50 h-96 flex flex-col shadow-sm"><h4 class="font-black text-[10px] mb-4 uppercase">Curva S</h4><div class="flex-grow relative h-full w-full"><canvas id="scurve-chart"></canvas></div></div><div class="border p-6 rounded-[30px] bg-slate-50 h-96 flex flex-col shadow-sm"><h4 class="font-black text-[10px] mb-4 uppercase">Status</h4><div class="flex-grow relative h-full w-full"><canvas id="pie-chart"></canvas></div></div></div></div>
            <div id="v-bal" class="view hidden h-full flex bg-slate-50"><div class="w-3/4 p-6 overflow-y-auto"><div class="h-[600px] border p-6 rounded-3xl bg-white shadow-sm relative"><div class="flex justify-between items-center mb-6"><h3 class="font-black text-[11px] uppercase text-blue-600">Linha de Balanço</h3><span class="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-bold">Exibindo apenas Pendentes (< 100%)</span></div><div class="absolute inset-x-6 bottom-6 top-16"><canvas id="balance-chart"></canvas></div></div></div><div class="w-1/4 p-6 border-l bg-white overflow-y-auto"><h3 class="font-black text-[11px] uppercase mb-4 text-slate-800 flex items-center gap-2"><i data-lucide="zap" class="w-4 text-yellow-500"></i> Alertas de Fluxo</h3><div id="lob-alerts" class="space-y-3 text-xs"></div></div></div>
            <div id="v-cash" class="view hidden p-10 bg-white h-full overflow-y-auto"><div class="max-w-6xl mx-auto"><h2 class="text-3xl font-black text-slate-800 mb-2">Fluxo de Caixa</h2><p class="text-slate-400 text-xs mb-10">Clique em uma barra para ver o detalhamento.</p><div class="h-[500px] border p-4 rounded-2xl shadow-sm"><canvas id="cash-chart"></canvas></div></div></div>
        </main>
    </div>

    <div id="modal-create-type" class="modal"><div class="bg-white p-8 rounded-[30px] w-[500px] shadow-2xl flex flex-col items-center"><h2 class="text-xl font-black text-slate-800 mb-6 uppercase">Como deseja criar?</h2><div class="grid grid-cols-2 gap-4 w-full mb-6"><button onclick="projectManager.createManual()" class="bg-slate-100 hover:bg-slate-200 p-6 rounded-2xl flex flex-col items-center gap-3 border-2 border-transparent hover:border-slate-300 transition"><i data-lucide="file-plus" class="w-8 h-8 text-slate-500"></i><span class="text-xs font-black uppercase text-slate-700">Manual (Branco)</span></button><button onclick="projectManager.createWizard()" class="bg-blue-50 hover:bg-blue-100 p-6 rounded-2xl flex flex-col items-center gap-3 border-2 border-transparent hover:border-blue-300 transition"><i data-lucide="bot" class="w-8 h-8 text-blue-600"></i><span class="text-xs font-black uppercase text-blue-700">Assistente (IA)</span></button></div><button onclick="document.getElementById('modal-create-type').classList.remove('active')" class="text-slate-400 text-xs font-bold uppercase">Cancelar</button></div></div>
    <div id="modal-create-project" class="modal"><div class="bg-white p-8 rounded-[30px] w-[500px] shadow-2xl border-2 border-blue-500 flex flex-col max-h-[90vh]"><h3 class="font-black text-blue-600 mb-2 uppercase text-xs">Assistente de Criação</h3><h2 class="text-2xl font-black text-slate-800 mb-6">Novo Projeto</h2><div class="flex-grow overflow-y-auto pr-2 space-y-4"><div class="grid grid-cols-2 gap-4"><div class="col-span-2"><label class="block text-[10px] font-bold uppercase text-slate-500 mb-1">Nome da Obra</label><input type="text" id="cp-name" class="w-full border p-2 rounded-lg text-sm font-bold" placeholder="Ex: Residencial Vista"></div><div><label class="block text-[10px] font-bold uppercase text-slate-500 mb-1">Data Início</label><input type="date" id="cp-start" class="w-full border p-2 rounded-lg text-sm"></div><div><label class="block text-[10px] font-bold uppercase text-slate-500 mb-1">Subsolos</label><input type="number" id="cp-subs" class="w-full border p-2 rounded-lg text-sm" value="0" min="0"></div><div class="flex items-center gap-2 border p-2 rounded-lg"><input type="checkbox" id="cp-ground" checked class="w-4 h-4"><label for="cp-ground" class="text-xs font-bold text-slate-700">Possui Térreo?</label></div><div><label class="block text-[10px] font-bold uppercase text-slate-500 mb-1">Garagens (Sobressolo)</label><input type="number" id="cp-garage" class="w-full border p-2 rounded-lg text-sm" value="0" min="0"></div><div class="flex items-center gap-2 border p-2 rounded-lg col-span-2"><input type="checkbox" id="cp-lazer" class="w-4 h-4"><label for="cp-lazer" class="text-xs font-bold text-slate-700">Pavimento Lazer / PUC?</label></div><div><label class="block text-[10px] font-bold uppercase text-slate-500 mb-1">Pavimentos Tipo</label><input type="number" id="cp-tipo" class="w-full border p-2 rounded-lg text-sm" value="1" min="1"></div><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><input type="checkbox" id="cp-rooftop" class="w-4 h-4"><label for="cp-rooftop" class="text-xs font-bold text-slate-700">Rooftop?</label></div><div class="flex items-center gap-2"><input type="checkbox" id="cp-water" checked class="w-4 h-4"><label for="cp-water" class="text-xs font-bold text-slate-700">Barrilete/Cx. D'água</label></div></div></div></div><button onclick="projectManager.generateAndSave()" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-black text-xs uppercase hover:bg-blue-700 shadow-lg">GERAR CRONOGRAMA</button><button onclick="document.getElementById('modal-create-project').classList.remove('active')" class="w-full mt-2 text-slate-400 text-[9px] font-bold uppercase">Cancelar</button></div></div>
    <div id="modal-snapshots" class="modal"><div class="bg-white p-8 rounded-[30px] w-[500px] shadow-2xl border-2 border-indigo-500 flex flex-col"><h3 class="font-black text-indigo-600 mb-4 uppercase text-xs">Versões do Projeto</h3><p class="text-[10px] text-slate-400 mb-4">Crie snapshots de segurança. Você pode restaurar a qualquer momento.</p><div class="flex gap-2 mb-4"><input type="text" id="snapshot-name" placeholder="Nome (Ex: Pré-Revisão)" class="flex-grow border p-2 rounded text-xs"><button onclick="editor.createSnapshot()" class="bg-indigo-600 text-white px-4 rounded font-black text-[10px]">CRIAR VERSÃO</button></div><div id="snapshot-list" class="flex-grow overflow-y-auto max-h-60 space-y-2 bg-slate-50 p-2 rounded border"></div><button onclick="document.getElementById('modal-snapshots').classList.remove('active')" class="w-full mt-4 text-slate-400 text-[10px] uppercase font-bold">Fechar</button></div></div>
    <div id="modal-finance-detail" class="modal"><div class="bg-white p-8 rounded-[30px] w-[500px] max-h-[80vh] flex flex-col shadow-2xl"><h3 class="font-black text-blue-600 mb-2 uppercase text-xs">Detalhamento Financeiro</h3><p id="finance-detail-title" class="text-xl font-black text-slate-800 mb-6">Mês</p><div id="finance-list" class="flex-grow overflow-y-auto space-y-2 mb-4 pr-2 bg-slate-50 p-2 rounded-xl border"></div><div class="flex justify-between items-center pt-4 border-t"><span class="text-xs font-bold text-slate-500">TOTAL</span><span id="finance-total" class="text-xl font-black text-blue-600">R$ 0,00</span></div><button onclick="document.getElementById('modal-finance-detail').classList.remove('active')" class="w-full mt-4 bg-slate-900 text-white py-3 rounded-xl font-black text-[10px]">Fechar</button></div></div>
    <div id="modal-users" class="modal"><div class="bg-white p-8 rounded-[30px] w-96"><h3 class="font-black text-blue-600 mb-6 uppercase text-xs">Equipe</h3><div id="user-list" class="space-y-2 mb-6 max-h-48 overflow-y-auto"></div><div class="space-y-2 border-t pt-4"><input type="text" id="nu-u" placeholder="User" class="w-full border p-2 rounded text-xs"><input type="text" id="nu-p" placeholder="Pass" class="w-full border p-2 rounded text-xs"><button onclick="userManager.add()" class="w-full bg-slate-900 text-white py-2 rounded font-black text-[10px]">Add</button></div><button onclick="document.getElementById('modal-users').classList.remove('active')" class="w-full mt-4 text-xs">Fechar</button></div></div>
    <div id="modal-config" class="modal"><div class="bg-white p-8 rounded-[30px] w-[500px] shadow-2xl border border-slate-200 flex flex-col max-h-[90vh]"><h3 class="font-black text-blue-600 mb-4 uppercase text-xs">Configurações & Linhas de Base</h3><div class="mb-6 p-4 bg-orange-50 rounded-xl border border-orange-100 overflow-y-auto flex-grow"><h4 class="text-[10px] font-black text-orange-700 uppercase mb-2">Gerenciar Baselines (Comparativo)</h4><div class="flex gap-2 mb-4"><input type="text" id="new-baseline-name" placeholder="Nome (Ex: Rev.01)" class="flex-grow border p-2 rounded text-xs"><button onclick="editor.saveBaseline()" class="bg-orange-500 text-white px-3 rounded font-black text-[10px] hover:bg-orange-600">SALVAR</button></div><div id="baseline-list" class="space-y-2 max-h-40 overflow-y-auto bg-white p-2 rounded border"></div></div><div class="flex gap-4 mb-4"><label class="flex items-center gap-2 text-xs font-bold text-slate-700"><input type="checkbox" id="cfg-sat"> Sábado Útil</label><label class="flex items-center gap-2 text-xs font-bold text-slate-700"><input type="checkbox" id="cfg-sun"> Domingo Útil</label></div><div class="border-t pt-4 flex-grow overflow-hidden flex flex-col"><p class="text-[9px] font-black text-slate-400 mb-2 uppercase">Feriados</p><div id="holiday-list" class="max-h-24 overflow-y-auto mb-2 text-[10px] space-y-1"></div><div class="flex gap-2"><input type="date" id="new-holiday" class="border p-1 rounded text-xs flex-grow"><button onclick="editor.addHoliday()" class="bg-slate-900 text-white px-3 rounded hover:bg-slate-700">+</button></div></div><button onclick="editor.saveConfig()" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-black text-[10px] uppercase hover:bg-blue-700">Salvar Tudo</button><button onclick="document.getElementById('modal-config').classList.remove('active')" class="w-full mt-2 text-slate-400 text-[9px] font-bold uppercase">Fechar</button></div></div>
    <div id="modal-history" class="modal"><div class="bg-white p-8 rounded-[30px] w-[600px] max-h-[80vh] flex flex-col shadow-2xl border border-blue-200"><h3 class="font-black text-blue-700 mb-6 uppercase text-sm flex items-center gap-2"><i data-lucide="calendar" class="w-5"></i> Histórico de Medições</h3><div id="history-list" class="flex-grow overflow-y-auto space-y-3 mb-4 pr-2 min-h-[100px]"></div><button onclick="document.getElementById('modal-history').classList.remove('active')" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black text-xs">FECHAR</button></div></div>
    <div id="modal-history-detail" class="modal"><div class="bg-white p-8 rounded-[30px] w-[800px] max-h-[90vh] flex flex-col shadow-2xl border border-green-200"><h3 class="font-black text-green-700 mb-2 uppercase text-sm flex items-center gap-2"><i data-lucide="eye" class="w-5"></i> Espelho da Medição</h3><p id="history-detail-subtitle" class="text-xs text-slate-500 mb-4">...</p><div class="flex-grow overflow-y-auto border rounded bg-slate-50 p-4"><table class="w-full text-xs text-left"><thead class="bg-slate-200 font-bold uppercase text-slate-600"><tr><th class="p-2">Item / Grupo</th><th class="p-2 text-center">Acum. Anterior</th><th class="p-2 text-center">Medido no Período</th><th class="p-2 text-center">Acum. Total</th></tr></thead><tbody id="history-detail-body" class="divide-y divide-slate-200"></tbody></table></div><button onclick="document.getElementById('modal-history-detail').classList.remove('active')" class="w-full mt-4 bg-slate-900 text-white py-3 rounded-xl font-black text-xs">VOLTAR</button></div></div>
    <div id="modal-history-edit" class="modal"><div class="bg-white p-8 rounded-[30px] w-[500px] shadow-2xl border-2 border-yellow-400"><h3 class="font-black text-yellow-600 uppercase text-xs mb-4">Corrigir Medição Passada</h3><p class="text-[10px] text-slate-500 mb-4 bg-yellow-50 p-2 rounded">Atenção: Alterar um valor aqui recalculará o saldo acumulado atual.</p><div class="max-h-80 overflow-y-auto border rounded bg-white p-2 mb-4"><table class="w-full text-xs"><tbody id="history-edit-body"></tbody></table></div><button onclick="measurementEngine.saveCorrection()" class="w-full bg-yellow-500 text-white py-3 rounded-xl font-black text-[10px]">SALVAR CORREÇÃO</button><button onclick="document.getElementById('modal-history-edit').classList.remove('active')" class="w-full mt-2 text-slate-400 text-[9px] font-bold">CANCELAR</button></div></div>
    <div id="modal-purchase" class="modal"><div class="bg-white p-8 rounded-[30px] w-96 shadow-2xl border-2 border-purple-500"><h3 class="font-black text-purple-600 mb-2 uppercase text-xs">Configurar Compras</h3><p class="text-[10px] text-slate-400 mb-6" id="modal-purchase-title">Grupo</p><div class="flex gap-2 mb-6 bg-slate-100 p-1 rounded-lg"><button onclick="editor.setPurchaseMode('standard')" id="btn-p-standard" class="flex-1 py-2 rounded-md text-[10px] font-black uppercase transition">Padrão</button><button onclick="editor.setPurchaseMode('custom')" id="btn-p-custom" class="flex-1 py-2 rounded-md text-[10px] font-black uppercase transition">Personalizado</button></div><div id="panel-p-standard" class="text-center py-4 text-[10px] text-slate-500">Distribuição Linear.</div><div id="panel-p-custom" class="hidden space-y-3"><div><label class="text-[9px] font-bold uppercase">Meses Antes</label><input type="number" id="p-months" class="w-full border p-2 rounded text-xs" placeholder="0"></div><div class="flex gap-2"><div class="flex-1"><label class="text-[9px] font-bold uppercase">% Entrada</label><input type="number" id="p-entry" class="w-full border p-2 rounded text-xs" placeholder="0"></div><div class="flex-1"><label class="text-[9px] font-bold uppercase">Parcelas</label><input type="number" id="p-installments" class="w-full border p-2 rounded text-xs" placeholder="1"></div></div></div><button onclick="editor.savePurchase()" class="w-full mt-6 bg-purple-600 text-white py-3 rounded-xl font-black uppercase text-xs">Salvar</button><button onclick="document.getElementById('modal-purchase').classList.remove('active')" class="w-full mt-2 text-slate-400 text-[9px] font-bold uppercase">Cancelar</button></div></div>

    <script>
        const FB = "https://bravo-civil-default-rtdb.firebaseio.com/";
        const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

        const auth = {
            ss: null,
            async login() {
                const btn = document.getElementById('btn-login');
                const originalText = btn.innerText;
                btn.innerText = "Verificando...";
                btn.disabled = true;

                const u = document.getElementById('log-u').value;
                const p = document.getElementById('log-p').value;

                if (u === 'admin' && p === '123') {
                    this.ss = { u: 'Admin', role: 'ADMIN', id: 'local_admin' };
                    router.go('manager');
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }

                try {
                    const r = await fetch(`${FB}users.json`);
                    if (!r.ok) throw new Error("Banco de dados indisponível ou privado.");
                    const d = await r.json() || {};
                    for (let k in d) {
                        if (d[k].u === u && d[k].p === p) {
                            this.ss = { ...d[k], id: k };
                            await projectManager.load();
                            router.go('manager');
                            return;
                        }
                    }
                    alert('Usuário ou senha incorretos');
                } catch (e) {
                    console.error(e);
                    alert('Erro ao conectar com o banco de dados:\n' + e.message + '\n\nTente usar o login local: admin / 123');
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        };

        const userManager = {
            open() { document.getElementById('modal-users').classList.add('active'); this.render(); },
            async render() {
                if (auth.ss.id === 'local_admin') {
                    document.getElementById('user-list').innerHTML = '<p class="text-xs text-orange-500 italic text-center">Gestão de equipe indisponível no modo local.</p>';
                    return;
                }
                try {
                    const r = await fetch(`${FB}users.json`);
                    const d = await r.json() || {};
                    document.getElementById('user-list').innerHTML = Object.keys(d)
                        .filter(k => d[k].owner === auth.ss.id)
                        .map(k => `<div class="flex justify-between text-xs bg-white p-2 rounded shadow-sm mb-1"><span>${d[k].u}</span><button onclick="userManager.del('${k}')" class="text-red-500">x</button></div>`)
                        .join('');
                } catch (e) {
                    document.getElementById('user-list').innerHTML = '<p class="text-xs text-red-500">Erro ao carregar equipe.</p>';
                }
            },
            async add() {
                if (auth.ss.id === 'local_admin') return alert("Indisponível offline.");
                const u = document.getElementById('nu-u').value;
                const p = document.getElementById('nu-p').value;
                if (u && p) {
                    await fetch(`${FB}users/u${Date.now()}.json`, { method: 'PUT', body: JSON.stringify({ u, p, role: 'COLABORADOR', owner: auth.ss.id }) });
                    this.render();
                }
            },
            async del(id) { 
                if (auth.ss.id === 'local_admin') return;
                await fetch(`${FB}users/${id}.json`, { method: 'DELETE' }); 
                this.render(); 
            }
        };

        const measurementEngine = {
            editingHistoryId: null,
            async saveSnapshot() {
                if (!confirm("Confirmar fechamento da medição atual?")) return;
                if (!editor.curr) { alert("Erro: Projeto não carregado."); return; }
                const items = editor.db.filter(t => t.type === 'item');
                if (items.length === 0) { alert("Erro: Não há itens para medir."); return; }

                const snapshot = {
                    id: 'm' + Date.now(),
                    date: new Date().toISOString(),
                    user: auth.ss ? auth.ss.u : 'Admin',
                    items: items.map(t => ({ uuid: t.uuid, name: t.name, progress: parseFloat(t.progress || 0), cost: parseFloat(t.cost || 0) }))
                };

                if (!editor.measurements) editor.measurements = [];
                editor.measurements.push(snapshot);

                const btn = document.querySelector('button[onclick="measurementEngine.saveSnapshot()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = "SALVANDO...";
                btn.disabled = true;

                try {
                    const pIndex = projectManager.all.findIndex(p => p.id === editor.curr);
                    if (pIndex === -1) throw new Error("Projeto perdido");
                    projectManager.all[pIndex].measurements = editor.measurements;
                    projectManager.all[pIndex].data = editor.db;
                    await projectManager.save();
                    
                    const reloadedP = projectManager.all.find(p => p.id === editor.curr);
                    editor.measurements = reloadedP.measurements || [];
                    editor.recalc();
                    alert("Medição salva e sincronizada com sucesso!");
                } catch (e) {
                    console.error(e);
                    alert("Erro fatal ao salvar medição.");
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    this.viewHistory();
                }
            },

            viewHistory() {
                document.getElementById('modal-history').classList.add('active');
                const list = document.getElementById('history-list');
                const mList = editor.measurements || [];

                if (mList.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center h-40 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50"><i data-lucide="clipboard-x" class="w-8 h-8 text-slate-400 mb-2"></i><p class="text-slate-500 font-bold text-xs">Nenhuma medição encontrada.</p></div>`;
                    lucide.createIcons();
                    return;
                }

                list.innerHTML = mList.map((m, i) => {
                    const d = new Date(m.date);
                    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const totalCost = m.items.reduce((acc, it) => acc + (parseFloat(it.cost) || 0), 0);
                    const totalEarned = m.items.reduce((acc, it) => acc + ((parseFloat(it.cost) || 0) * (it.progress/100)), 0);
                    const globalPerc = totalCost ? Math.round((totalEarned / totalCost) * 100) : 0;
                    return `<div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center hover:border-blue-300 transition mb-2 group"><div class="cursor-pointer flex-grow" onclick="measurementEngine.viewDetail('${m.id}')"><div class="flex items-center gap-2 mb-1"><span class="bg-blue-600 text-white px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wider">M${i+1}</span><span class="text-xs font-bold text-slate-700">${dateStr}</span></div><p class="text-[10px] text-slate-400 flex items-center gap-1"><i data-lucide="user" class="w-3"></i> ${m.user}</p></div><div class="flex items-center gap-4"><div class="text-right"><span class="block text-xl font-black text-slate-800 leading-none">${globalPerc}%</span><span class="text-[8px] text-slate-400 uppercase font-bold">Avanço</span></div><div class="flex gap-1 pl-4 border-l"><button onclick="measurementEngine.openCorrection('${m.id}')" class="p-2 text-slate-300 hover:text-yellow-600 hover:bg-yellow-50 rounded transition" title="Corrigir"><i data-lucide="edit-2" class="w-4"></i></button><button onclick="measurementEngine.delete('${m.id}')" class="p-2 text-slate-300 hover:text-red-600 hover:bg-red-50 rounded transition" title="Excluir"><i data-lucide="trash-2" class="w-4"></i></button></div></div></div>`;
                }).reverse().join('');
                lucide.createIcons();
            },

            viewDetail(mid) {
                const m = editor.measurements.find(x => x.id === mid);
                if (!m) return;
                const mIndex = editor.measurements.findIndex(x => x.id === mid);
                const prevM = mIndex > 0 ? editor.measurements[mIndex - 1] : null;

                document.getElementById('modal-history').classList.remove('active');
                document.getElementById('modal-history-detail').classList.add('active');
                document.getElementById('history-detail-subtitle').innerText = `${new Date(m.date).toLocaleString()} - Responsável: ${m.user}`;

                const tbody = document.getElementById('history-detail-body');
                tbody.innerHTML = m.items.map(item => {
                    let prevProg = 0;
                    if (prevM) {
                        const prevItem = prevM.items.find(pi => pi.uuid === item.uuid);
                        if (prevItem) prevProg = prevItem.progress;
                    }
                    const delta = (item.progress - prevProg).toFixed(2);
                    
                    const currentTask = editor.db.find(t => t.uuid === item.uuid);
                    let groupName = "";
                    if (currentTask && currentTask.parent) {
                        const parent = editor.db.find(p => p.uuid === currentTask.parent);
                        if(parent) groupName = parent.name;
                    }

                    if (item.progress > 0 || prevProg > 0) {
                        const deltaClass = delta > 0 ? "text-blue-600 bg-blue-50" : (delta < 0 ? "text-red-600 bg-red-50" : "text-slate-400");
                        const deltaSign = delta > 0 ? "+" : "";
                        return `<tr class="hover:bg-slate-50 transition border-b border-slate-100"><td class="p-3 font-medium text-slate-700 text-[10px]"><span class="block text-[9px] text-slate-400 font-bold uppercase mb-0.5">${groupName}</span>${item.name}</td><td class="p-3 text-center text-slate-400 font-bold">${prevProg}%</td><td class="p-3 text-center font-bold ${deltaClass} rounded-lg">${deltaSign}${delta}%</td><td class="p-3 text-center font-black text-slate-900">${item.progress}%</td></tr>`;
                    }
                    return '';
                }).join('');
            },

            async delete(mid) {
                if (!confirm("ATENÇÃO: Excluir esta medição pode afetar o cálculo do 'Acumulado Anterior'. Continuar?")) return;
                editor.measurements = editor.measurements.filter(x => x.id !== mid);
                const pIndex = projectManager.all.findIndex(p => p.id === editor.curr);
                if (pIndex !== -1) {
                    projectManager.all[pIndex].measurements = editor.measurements;
                    await projectManager.save();
                    editor.recalc();
                    this.viewHistory();
                }
            },

            openCorrection(mid) {
                this.editingHistoryId = mid;
                const m = editor.measurements.find(x => x.id === mid);
                if (!m) return;
                document.getElementById('modal-history').classList.remove('active');
                document.getElementById('modal-history-edit').classList.add('active');
                document.getElementById('history-edit-body').innerHTML = m.items.map(item => `
                    <tr class="border-b"><td class="p-2 text-slate-700 truncate max-w-[200px]">${item.name}</td><td class="p-2 text-right"><input type="number" value="${item.progress}" min="0" max="100" class="border p-1 w-20 text-center rounded font-bold text-slate-800 focus:border-blue-500 outline-none" id="edit-hist-${item.uuid}"> <span class="text-slate-400">%</span></td></tr>`).join('');
            },

            async saveCorrection() {
                const m = editor.measurements.find(x => x.id === this.editingHistoryId);
                if (m) {
                    m.items.forEach(item => {
                        const el = document.getElementById(`edit-hist-${item.uuid}`);
                        if (el) item.progress = parseFloat(el.value) || 0;
                    });
                    const pIndex = projectManager.all.findIndex(p => p.id === editor.curr);
                    if (pIndex !== -1) {
                        projectManager.all[pIndex].measurements = editor.measurements;
                        await projectManager.save();
                        editor.recalc();
                        alert("Correção aplicada.");
                        document.getElementById('modal-history-edit').classList.remove('active');
                        this.viewHistory();
                    }
                }
            }
        };

        const editor = {
            curr: null, db: [], eap: [], kb: [], measurements: [], cfg: {}, baselines: [], snapshots: [], charts: {}, 
            mode: 'planning', ganttViewMode: 'Day', zoomLevel: 1, editingGroup: null, editingHistoryIndex: null,
            drag: { active: false, item: null }, link: { active: false, source: null }, 
            eapPan: { active: false, startX: 0, startY: 0, transX: 0, transY: 0 }, 
            financialBreakdown: {},
            linkingState: { active: false, source: null },

            async open(id) {
                this.curr = id;
                const p = projectManager.all.find(x => x.id === id);
                if (!p.kb) p.kb = [];
                if (!p.measurements) p.measurements = [];
                this.db = p.data || [];
                this.eap = p.eap || [];
                this.kb = p.kb;
                this.measurements = p.measurements;
                this.cfg = p.cfg || { sat: false, sun: false, holidays: [] };
                this.baselines = p.baselines || [];
                this.snapshots = p.snapshots || [];
                document.getElementById('edit-name').innerText = p.name.toUpperCase();
                router.go('editor');
                this.recalc(false);
                setTimeout(() => { this.setupSync(); this.initEapDrag(); }, 500);
            },

            close() { this.curr = null; router.go('manager'); },

            setupSync() {
                const t = document.getElementById('wrapper-table');
                const g = document.getElementById('wrapper-gantt');
                let isSyncingLeft = false, isSyncingRight = false;
                if (t && g) {
                    t.onscroll = function() { if (!isSyncingLeft) { isSyncingRight = true; g.scrollTop = t.scrollTop; } isSyncingLeft = false; };
                    g.onscroll = function() { if (!isSyncingRight) { isSyncingLeft = true; t.scrollTop = g.scrollTop; } isSyncingRight = false; };
                }
            },
            isWorkDay(date) { const d = new Date(date + "T00:00:00"); if (!this.cfg.sat && d.getDay() === 6) return false; if (!this.cfg.sun && d.getDay() === 0) return false; if ((this.cfg.holidays || []).includes(date)) return false; return true; },
            addWorkDays(start, days) { let d = new Date(start + "T00:00:00"), c = 0, n = parseInt(days) - 1; while (c < n) { d.setDate(d.getDate() + 1); if (this.isWorkDay(d.toISOString().split('T')[0])) c++; } return d.toISOString().split('T')[0]; },
            getNextWorkDay(dateStr) { let d = new Date(dateStr + "T00:00:00"); do { d.setDate(d.getDate() + 1); } while (!this.isWorkDay(d.toISOString().split('T')[0])); return d.toISOString().split('T')[0]; },
            getDuration(start, end) { let d1 = new Date(start + "T00:00:00"), d2 = new Date(end + "T00:00:00"), c = 0; if (d2 < d1) return 1; while (d1 <= d2) { if (this.isWorkDay(d1.toISOString().split('T')[0])) c++; d1.setDate(d1.getDate() + 1); } return c; },
            changeGanttMode(m) { this.ganttViewMode = m; this.renderG(); },

            // --- LÓGICA DE LINKAGEM ---
            toggleLinkMode() {
                this.linkingState.active = !this.linkingState.active;
                this.linkingState.source = null; 
                
                const btn = document.getElementById('btn-link-mode');
                if (this.linkingState.active) {
                    document.body.classList.add('linking-mode');
                    btn.classList.remove('bg-slate-200', 'text-slate-600');
                    btn.classList.add('bg-blue-600', 'text-white', 'animate-pulse');
                    btn.innerHTML = `<i data-lucide="link-2" class="w-3"></i> SELECIONE A PREDECESSORA`;
                } else {
                    document.body.classList.remove('linking-mode');
                    btn.classList.add('bg-slate-200', 'text-slate-600');
                    btn.classList.remove('bg-blue-600', 'text-white', 'animate-pulse');
                    btn.innerHTML = `<i data-lucide="link" class="w-3"></i> LIGAR TAREFAS`;
                    this.renderT();
                }
                lucide.createIcons();
            },

            handleRowClick(uuid) {
                if (!this.linkingState.active) return;
                
                if (!this.linkingState.source) {
                    this.linkingState.source = uuid;
                    this.renderT();
                    const btn = document.getElementById('btn-link-mode');
                    btn.innerHTML = `<i data-lucide="arrow-down-circle" class="w-3"></i> CLIQUE NA SUCESSORA`;
                    lucide.createIcons();
                    return;
                }

                if (this.linkingState.source === uuid) {
                    this.linkingState.source = null;
                    this.renderT();
                    return;
                }

                const target = this.db.find(x => x.uuid === uuid);
                if (target) {
                    if (!target.pred) target.pred = [];
                    if (!target.pred.includes(this.linkingState.source)) {
                        target.pred.push(this.linkingState.source);
                        this.recalc(); 
                    }
                }
                this.linkingState.source = null;
                document.getElementById('btn-link-mode').innerHTML = `<i data-lucide="link-2" class="w-3"></i> SELECIONE A PREDECESSORA`;
                lucide.createIcons();
                this.renderT();
            },

            getRowNumber(uuid) {
                return this.db.findIndex(x => x.uuid === uuid) + 1;
            },

            moveItem(uuid, direction) {
                const index = this.db.findIndex(x => x.uuid === uuid);
                if (index === -1) return;

                const item = this.db[index];
                const newIndex = index + direction;

                if (newIndex < 1 || newIndex >= this.db.length) return; 

                const neighbor = this.db[newIndex];
                if (item.parent !== neighbor.parent && item.type !== 'group') {
                    alert("Para manter a organização, mova itens apenas dentro do seu próprio grupo.");
                    return;
                }

                if (item.type === 'item') {
                    [this.db[index], this.db[newIndex]] = [this.db[newIndex], this.db[index]];
                } 
                else if (item.type === 'group') {
                    alert("Mover Grupos inteiros requer arrastar e soltar (recurso futuro). Por enquanto, mova as tarefas.");
                    return;
                }
                this.recalc();
            },

            recalc(shouldSave = true) {
                let changes = true, loops = 0;
                this.db.forEach(t => t.critical = false);
                while (changes && loops < 15) {
                    changes = false;
                    this.db.forEach(t => {
                        if (t.type === 'item' && !this.db.some(c => c.parent === t.uuid)) {
                            if (t.pred && t.pred.length) {
                                let max = null;
                                t.pred.forEach(pid => { const p = this.db.find(x => x.uuid === pid); if (p && p.end && (!max || p.end > max)) max = p.end; });
                                if (max) { const ns = this.getNextWorkDay(max); if (t.start !== ns) { t.start = ns; changes = true; } }
                            } else if (!t.start) t.start = new Date().toISOString().split('T')[0];
                            if (t.start && t.duration) { const ne = this.addWorkDays(t.start, t.duration); if (t.end !== ne) { t.end = ne; changes = true; } }
                        }
                    });
                    loops++;
                }
                
                for(let k=0; k<6; k++) {
                    this.db.forEach(g => {
                        const ch = this.db.filter(x => x.parent === g.uuid);
                        if (ch.length) {
                            const starts = ch.map(c => c.start).filter(Boolean).sort();
                            const ends = ch.map(c => c.end).filter(Boolean).sort().reverse();
                            if(starts.length) g.start = starts[0];
                            if(ends.length) g.end = ends[0];
                            g.cost = ch.reduce((s, c) => s + (parseFloat(c.cost) || 0), 0);
                            if (g.cost > 0) {
                                const earned = ch.reduce((s,c) => s + ((parseFloat(c.cost)||0)*(c.progress||0)/100),0);
                                g.progress = Math.round((earned/g.cost)*100);
                            } else {
                                g.progress = Math.round(ch.reduce((s,c) => s + (c.progress||0),0)/ch.length);
                            }
                        }
                    });
                }
                
                if (this.db.length > 0) {
                    const allStart = this.db.map(t => t.start).filter(Boolean).sort()[0];
                    const allEnd = this.db.map(t => t.end).filter(Boolean).sort().reverse()[0];
                    const totalCost = this.db.filter(t => t.type === 'item').reduce((acc, t) => acc + (parseFloat(t.cost) || 0), 0);
                    this.db[0].name = "RESUMO DO PROJETO";
                    this.db[0].start = allStart || new Date().toISOString().split('T')[0];
                    this.db[0].end = allEnd || this.db[0].start;
                    this.db[0].cost = totalCost;
                    this.db[0].duration = this.getDuration(this.db[0].start, this.db[0].end);
                }

                const ld = this.db.map(t => t.end).filter(Boolean).sort().reverse()[0];
                if(ld) this.db.filter(t => t.end === ld && t.type === 'item').forEach(t => this.traceCritical(t.uuid));
                
                this.renderT();
                this.renderSiteView();
                setTimeout(() => this.renderG(), 50);
                if (shouldSave) this.autoSave();
            },

            renderSiteView() {
                const today = new Date();
                today.setHours(0,0,0,0);
                document.getElementById('site-date').innerText = today.toLocaleDateString();

                let delayCount = 0;
                let monthCount = 0;
                let totalItems = 0;
                let doneItems = 0;

                const delayTable = document.getElementById('site-delay-table');
                const monthTable = document.getElementById('site-month-table');
                delayTable.innerHTML = '';
                monthTable.innerHTML = '';

                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();

                this.db.forEach(t => {
                    if(t.type === 'item') {
                        totalItems++;
                        if(t.progress >= 100) doneItems++;

                        const endDate = new Date(t.end + 'T00:00:00');
                        if (t.progress < 100 && endDate < today) {
                            delayCount++;
                            const diffTime = Math.abs(today - endDate);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                            const parent = this.db.find(p => p.uuid === t.parent);
                            const parentName = parent ? parent.name : '-';
                            delayTable.innerHTML += `<tr class="hover:bg-red-50 border-b border-slate-100 last:border-0"><td class="p-3 font-bold text-slate-700">${parentName}</td><td class="p-3 text-slate-600">${t.name}</td><td class="p-3 text-center text-slate-500">${new Date(t.end).toLocaleDateString()}</td><td class="p-3 text-center font-black text-red-600 bg-red-100 rounded">${diffDays} dias</td><td class="p-3 text-center font-bold text-slate-800">${t.progress}%</td></tr>`;
                        }

                        const startDate = new Date(t.start + 'T00:00:00');
                        if ((startDate.getMonth() === currentMonth && startDate.getFullYear() === currentYear) || (endDate.getMonth() === currentMonth && endDate.getFullYear() === currentYear) || (startDate < today && endDate > today)) {
                            if(t.progress < 100) {
                                monthCount++;
                                const parent = this.db.find(p => p.uuid === t.parent);
                                const parentName = parent ? parent.name : '-';
                                monthTable.innerHTML += `<tr class="hover:bg-blue-50 border-b border-slate-100 last:border-0"><td class="p-3 font-bold text-slate-700">${parentName}</td><td class="p-3 text-slate-600">${t.name}</td><td class="p-3 text-center font-bold text-slate-500">${new Date(t.start).toLocaleDateString()}</td><td class="p-3 text-center font-bold text-slate-500">${new Date(t.end).toLocaleDateString()}</td></tr>`;
                            }
                        }
                    }
                });

                document.getElementById('site-delay-count').innerText = delayCount;
                document.getElementById('site-month-count').innerText = monthCount;
                document.getElementById('site-global-prog').innerText = totalItems > 0 ? Math.round((doneItems/totalItems)*100) + '%' : '0%';

                if(delayCount === 0) delayTable.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400 italic">Nenhum atraso detectado. Parabéns!</td></tr>`;
                if(monthCount === 0) monthTable.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-400 italic">Nada previsto para este mês.</td></tr>`;
            },

            traceCritical(uid) { const t = this.db.find(x => x.uuid === uid); if (t && !t.critical) { t.critical = true; (t.pred || []).forEach(pid => this.traceCritical(pid)); } },
            printPresentation() { editor.switchView('dash'); window.print(); },
            exportCSV() {
                const rows = [["ID", "Nome", "Tipo", "Inicio", "Fim", "Duracao (dias)", "Custo (R$)", "Progresso (%)", "Predecessoras"]];
                this.db.forEach(t => {
                    rows.push([
                        t.uuid,
                        t.name,
                        t.type === 'group' ? 'GRUPO' : 'TAREFA',
                        t.start || '',
                        t.end || '',
                        t.duration || 0,
                        (t.cost || 0).toString().replace('.', ','), 
                        (t.progress || 0).toString().replace('.', ','),
                        (t.pred || []).join(',')
                    ]);
                });
                
                let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(";")).join("\n"); 
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `bravo_export_${this.curr}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                link.remove();
            },

            initEapDrag() {
                const vp = document.getElementById('eap-viewport'); const canvas = document.getElementById('eap-canvas');
                vp.onmousedown = (e) => { if (e.button === 1) { e.preventDefault(); editor.eapPan.active = true; editor.eapPan.startX = e.clientX; editor.eapPan.startY = e.clientY; } else if (e.button === 0 && e.target.id === 'eap-svg') { editor.link = { active: false, source: null }; document.body.classList.remove('linking-cursor'); editor.renderEAP(); } };
                vp.onmousemove = (e) => { if (editor.eapPan.active) { editor.eapPan.transX += e.clientX - editor.eapPan.startX; editor.eapPan.transY += e.clientY - editor.eapPan.startY; editor.eapPan.startX = e.clientX; editor.eapPan.startY = e.clientY; canvas.style.transform = `translate(${editor.eapPan.transX}px, ${editor.eapPan.transY}px) scale(${editor.zoomLevel})`; } else if (editor.drag.active) { const n = editor.eap.find(x => x.uuid === editor.drag.item); if (n) { n.x = parseInt(n.x) + e.movementX / editor.zoomLevel; n.y = parseInt(n.y) + e.movementY / editor.zoomLevel; editor.renderEAP(); } } };
                vp.onmouseup = () => { editor.eapPan.active = false; if (editor.drag.active) { editor.drag.active = false; editor.autoSave(); } };
                vp.oncontextmenu = (e) => e.preventDefault();
            },

            renderEAP() {
                document.getElementById('eap-nodes-layer').innerHTML = '';
                this.eap.forEach(n => {
                    const isLinking = this.link.active && this.link.source === n.uuid;
                    const el = document.createElement('div'); el.className = `eap-node ${isLinking ? 'linking-mode' : ''}`; el.style.left = n.x + 'px'; el.style.top = n.y + 'px';
                    el.innerHTML = `<div class="eap-header" onmousedown="editor.startEapDrag(event, '${n.uuid}')"><span class="text-[9px] font-black uppercase text-slate-500">ID: ${n.uuid.substr(-4)}</span><div class="eap-btn btn-del hover:text-red-500 cursor-pointer" onclick="event.stopPropagation(); editor.remEap('${n.uuid}')">x</div></div><div class="eap-body" onclick="editor.handleEapBodyClick(event, '${n.uuid}')"><input value="${n.name}" onchange="editor.updEap('${n.uuid}','name',this.value)" class="w-full text-xs font-bold text-center outline-none bg-transparent mb-1"><div class="flex justify-center pb-2"><button class="bg-slate-200 text-[9px] px-2 rounded hover:bg-slate-300 font-bold text-slate-600" onclick="event.stopPropagation(); editor.toggleLink('${n.uuid}')"># LINK</button></div></div>`;
                    document.getElementById('eap-nodes-layer').appendChild(el);
                });
                this.drawEapLines();
                document.getElementById('eap-canvas').style.transform = `translate(${editor.eapPan.transX}px, ${editor.eapPan.transY}px) scale(${editor.zoomLevel})`;
            },
            
            drawEapLines() {
                const svg = document.getElementById('eap-svg');
                while(svg.firstChild) svg.removeChild(svg.firstChild);
                
                const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
                marker.setAttribute("id", "arrow");
                marker.setAttribute("viewBox", "0 0 10 10");
                marker.setAttribute("refX", "10");
                marker.setAttribute("refY", "5");
                marker.setAttribute("markerWidth", "6");
                marker.setAttribute("markerHeight", "6");
                marker.setAttribute("orient", "auto");
                
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", "M 0 0 L 10 5 L 0 10 z");
                path.setAttribute("fill", "#64748b");
                
                marker.appendChild(path);
                defs.appendChild(marker);
                svg.appendChild(defs);

                this.eap.forEach(n => {
                    (n.links || []).forEach(tid => {
                        const t = this.eap.find(x => x.uuid === tid);
                        if (t) {
                            const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            l.setAttribute('x1', parseInt(n.x) + 90);
                            l.setAttribute('y1', parseInt(n.y) + 40);
                            l.setAttribute('x2', parseInt(t.x) + 90);
                            l.setAttribute('y2', parseInt(t.y) + 40);
                            l.setAttribute('stroke', '#64748b');
                            l.setAttribute('stroke-width', '2');
                            l.setAttribute('marker-end', 'url(#arrow)');
                            svg.appendChild(l);
                        }
                    });
                });
            },

            startEapDrag(e, uuid) { if (e.button === 0) { this.drag = { active: true, item: uuid }; e.stopPropagation(); } },
            handleEapBodyClick(e, uuid) { if (this.link.active && this.link.source !== uuid) { this.finishLink(uuid); e.stopPropagation(); } },
            toggleLink(u) { if (this.link.active && this.link.source === u) { this.link = { active: false, source: null }; document.body.classList.remove('linking-cursor'); } else { this.link = { active: true, source: u }; document.body.classList.add('linking-cursor'); } this.renderEAP(); },
            finishLink(t) { const s = this.eap.find(x => x.uuid === this.link.source); if (s && t !== this.link.source) { s.links = s.links || []; if (!s.links.includes(t)) s.links.push(t); } this.link = { active: false, source: null }; document.body.classList.remove('linking-cursor'); this.renderEAP(); this.autoSave(); },
            addEapNode() { this.eap.push({ uuid: 'e'+Date.now(), name: 'Item', x: 100, y: 100, links: [] }); this.renderEAP(); this.autoSave(); },
            updEap(u, f, v) { this.eap.find(x => x.uuid === u)[f] = v; this.autoSave(); },
            remEap(u) { this.eap = this.eap.filter(x => x.uuid !== u); this.renderEAP(); this.autoSave(); },
            zoom(d) { this.zoomLevel += d; if (this.zoomLevel < 0.5) this.zoomLevel = 0.5; this.renderEAP(); },
            resetZoom() { this.zoomLevel = 1; this.renderEAP(); },

            upd(u, f, v) { const t = this.db.find(x => x.uuid === u); if (f==='duration'||f==='cost') t[f]=parseFloat(v)||0; else t[f]=v; this.recalc(); },
            updEnd(u, v) { const t = this.db.find(x => x.uuid === u); t.end = v; t.duration = this.getDuration(t.start, t.end); this.recalc(); },
            updPr(u, v) { const parts = v.split(','); const finalPreds = []; parts.forEach(p => { p = p.trim(); if (!p) return; if (!isNaN(p)) { const idx = parseInt(p) - 1; if (this.db[idx]) finalPreds.push(this.db[idx].uuid); } else { finalPreds.push(p); } }); this.db.find(x => x.uuid === u).pred = finalPreds; this.recalc(); },
            addItem(parentId) { const p = this.db.find(x => x.uuid === parentId); if(p) p.collapsed=false; let idx = -1; for(let i=0; i<this.db.length; i++) { if(this.db[i].uuid===parentId || this.db[i].parent===parentId) idx=i; } if(idx!==-1) { this.db.splice(idx+1, 0, { uuid: 't'+Date.now(), name: 'Nova Tarefa', type: 'item', parent: parentId, duration: 5, start: new Date().toISOString().split('T')[0], progress: 0, cost: 0 }); this.recalc(); } },
            addGroup() { this.db.push({ uuid: 'g'+Date.now(), name: 'NOVA ETAPA', type: 'group', parent: 'root', cost: 0, progress: 0, collapsed: false }); this.recalc(); setTimeout(() => document.getElementById('wrapper-table').scrollTop = document.getElementById('wrapper-table').scrollHeight, 100); },
            toggleAllGroups(c) { this.db.forEach(t => { if(t.type==='group'||this.db.some(x=>x.parent===t.uuid)) t.collapsed=c; }); this.recalc(false); },
            toggleGroup(u) { const g = this.db.find(x=>x.uuid===u); if(g) g.collapsed=!g.collapsed; this.recalc(false); },
            rem(u) { if(confirm("Del?")) { let del=[u]; let added=true; while(added){added=false; this.db.forEach(t=>{if(del.includes(t.parent)&&!del.includes(t.uuid)){del.push(t.uuid);added=true;}});} this.db=this.db.filter(x=>!del.includes(x.uuid)); this.recalc(); } },
            cloneGroup(gid) { const gIdx = this.db.findIndex(x => x.uuid === gid); if (gIdx === -1) return; const og = this.db[gIdx]; const kids = this.db.filter(x => x.parent === gid); const newGid = 'g' + Date.now(); const newG = { ...og, uuid: newGid, name: og.name + ' (Cópia)' }; const newKids = kids.map((k, i) => ({ ...k, uuid: 't' + Date.now() + i, parent: newGid, progress: 0 })); let ins = gIdx; while (ins + 1 < this.db.length && this.db[ins + 1].parent === gid) ins++; this.db.splice(ins + 1, 0, newG, ...newKids); this.recalc(); },
            
            handleTableKey(e, i) { if(e.key==='Enter') { e.preventDefault(); i.blur(); const c = i.closest('td'); const r = c.closest('tr'); const nr = r.nextElementSibling; if (nr) { const tc = nr.children[c.cellIndex]; if (tc) { const ti = tc.querySelector('input'); if (ti && !ti.disabled) ti.focus(); } } } },

            renderT() {
                const thead = document.getElementById('table-head-row');
                if (this.mode === 'planning') {
                    thead.innerHTML = `<th class="w-8">#</th><th class="text-left">Descrição</th><th class="w-24">Início</th><th class="w-24">Término</th><th class="w-16">Duração</th><th class="w-24">Custo</th><th class="w-16">Links</th><th class="w-20">Ações</th>`;
                } else {
                    thead.innerHTML = `<th class="w-8">#</th><th class="text-left">Descrição</th><th class="w-28 text-center text-slate-400 bg-slate-50 border-r border-slate-200">Físico Acumulado<br><span class="text-[8px] uppercase">(Anterior)</span></th><th class="w-32 text-center bg-blue-600 text-white font-black border-x border-blue-700">FÍSICO ATUAL<br><span class="text-[8px] opacity-80 uppercase">(Input Período)</span></th><th class="w-24 text-center font-bold text-slate-900 border-r border-slate-200">Novo Saldo<br><span class="text-[8px] uppercase text-slate-400">(Total)</span></th><th class="w-24 text-center">Status</th>`;
                }
                
                let h = '';
                this.db.forEach((t, i) => {
                    const isG = t.type === 'group' || this.db.some(c=>c.parent===t.uuid);
                    if (!isG && this.db.find(p => p.uuid === t.parent)?.collapsed) return;
                    
                    const hasPred = t.pred && t.pred.length > 0;
                    const dateClass = hasPred ? 'blocked-cell' : 'input-cell text-center date-input';
                    
                    // Lógica para exibir o número da linha nos Links
                    let linkDisplay = ''; 
                    if (hasPred) {
                        linkDisplay = t.pred.map(uid => { const idx = this.db.findIndex(x => x.uuid === uid); return idx !== -1 ? (idx + 1) : '?'; }).join(', ');
                    }
                    const kd = `onkeydown="editor.handleTableKey(event, this)"`;
                    
                    const isRoot = i === 0;
                    let rowClasses = `${isG ? 'group-row' : ''} ${isRoot ? 'root-row' : ''} ${t.critical && !isG ? 'critical-row' : ''} hover:bg-slate-50 transition-colors`;
                    
                    if (this.linkingState.active) {
                        rowClasses += ' cursor-pointer row-linking-hover';
                        if (this.linkingState.source === t.uuid) {
                            rowClasses += ' row-linking-source';
                        }
                    }

                    h += `<tr class="${rowClasses}" onclick="editor.handleRowClick('${t.uuid}')">`;
                    h += `<td class="text-center text-[10px] text-slate-400 font-bold border-r">${i + 1}</td>`;
                    h += `<td class="flex items-center gap-2 pl-2 border-r">
                            ${isG && !isRoot ? `<button onclick="event.stopPropagation(); editor.toggleGroup('${t.uuid}')" class="font-bold w-4 h-4 flex items-center justify-center bg-white border rounded hover:bg-slate-100 mr-1">${t.collapsed ? '+' : '-'}</button>` : ''}
                            <input value="${t.name}" onchange="editor.upd('${t.uuid}','name',this.value)" onclick="event.stopPropagation()" ${kd} class="input-cell font-bold" ${isRoot ? 'disabled' : ''}>
                          </td>`;

                    if (this.mode === 'planning') {
                        h += `<td><input type="text" value="${t.start || ''}" data-id="${t.uuid}" data-field="start" onclick="event.stopPropagation()" class="${isG ? 'input-cell text-center' : dateClass}" ${isG || hasPred ? 'disabled' : ''}></td>
                              <td><input type="text" value="${t.end || ''}" data-id="${t.uuid}" data-field="end" onclick="event.stopPropagation()" class="${isG ? 'input-cell text-center' : 'input-cell text-center date-input'}" ${isG ? 'disabled' : ''}></td>
                              <td><input type="number" value="${t.duration || 1}" onchange="editor.upd('${t.uuid}','duration',this.value)" onclick="event.stopPropagation()" ${kd} class="input-cell text-center font-bold" ${isG ? 'disabled' : ''}></td>
                              <td class="text-right p-2">${isG ? fmt(t.cost) : `<input type="number" value="${t.cost || 0}" onchange="editor.upd('${t.uuid}','cost',this.value)" onclick="event.stopPropagation()" ${kd} class="input-cell text-right">`}</td>
                              <td><input value="${linkDisplay}" onchange="editor.updPr('${t.uuid}',this.value)" onclick="event.stopPropagation()" ${kd} class="input-cell text-center" placeholder="Ex: 1, 3"></td>
                        <td class="p-0 border-r no-print">
                            <div class="cell-actions" onclick="event.stopPropagation()">
                                ${!isG && i !== 0 ? `<button onclick="editor.moveItem('${t.uuid}', -1)" class="text-slate-400 hover:text-blue-600" title="Subir"><i data-lucide="arrow-up" class="w-3"></i></button><button onclick="editor.moveItem('${t.uuid}', 1)" class="text-slate-400 hover:text-blue-600" title="Descer"><i data-lucide="arrow-down" class="w-3"></i></button>` : ''}
                                ${!isG && i !== 0 ? `<div class="w-[1px] h-3 bg-slate-200 mx-1"></div>` : ''}
                                ${!isRoot ? `<button onclick="editor.rem('${t.uuid}')" class="text-red-300 hover:text-red-500" title="Excluir"><i data-lucide="trash-2" class="w-3.5"></i></button>` : ''}
                                ${isG && !isRoot ? `<button onclick="editor.cloneGroup('${t.uuid}')" class="text-slate-500 hover:text-slate-800" title="Duplicar"><i data-lucide="copy" class="w-3.5"></i></button>` : ''}
                                ${isG ? `<button onclick="editor.openPurchaseModal('${t.uuid}')" class="text-purple-600" title="Financeiro"><i data-lucide="dollar-sign" class="w-3.5"></i></button>` : ''}
                                ${isG ? `<button onclick="editor.addItem('${t.uuid}')" class="text-blue-500 hover:text-blue-700" title="Adicionar Item"><i data-lucide="plus-circle" class="w-3.5"></i></button>` : ''}
                            </div>
                        </td>`;
                    } else {
                        const prev = this.getLastSnapshotProgress(t.uuid);
                        const total = t.progress || 0;
                        let currentInput = Math.max(0, (total - prev).toFixed(2));
                        h += `<td class="text-center text-slate-500 font-medium text-[10px] bg-slate-50 border-r border-slate-200 select-none">${prev}%</td>`;
                        h += `<td class="border-x border-blue-700 bg-blue-50 p-1">${isG ? '<div class="text-center text-slate-300">-</div>' : `<input type="number" min="0" max="100" step="0.01" value="${currentInput}" onchange="editor.updMeasurementDelta('${t.uuid}', this.value, ${prev})" onclick="event.stopPropagation()" ${kd} class="w-full h-full text-center font-black text-blue-800 bg-white border border-blue-300 rounded focus:ring-4 focus:ring-blue-200 outline-none" placeholder="0">`}</td>`;
                        h += `<td class="text-center font-black text-slate-900 text-xs border-r border-slate-200 bg-white">${total}%</td>`;
                        h += `<td class="text-center text-[9px] font-bold ${total >= 100 ? 'text-green-600' : 'text-orange-500'}">${total >= 100 ? '100%' : 'EM ANDAMENTO'}</td>`;
                    }
                    h += '</tr>';
                });
                document.getElementById('tbody').innerHTML = h;
                lucide.createIcons();
                this.setupDatePickers();
            },
            
            setupDatePickers() {
                const els = document.querySelectorAll('.date-input');
                if(els.length > 0) {
                    flatpickr(els, {
                        dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y", locale: "pt", allowInput: true,
                        onChange: function(selectedDates, dateStr, instance) {
                            const input = instance.element;
                            const uuid = input.getAttribute('data-id');
                            const field = input.getAttribute('data-field');
                            if(uuid && field) {
                                if(field === 'start') editor.upd(uuid, 'start', dateStr);
                                if(field === 'end') editor.updEnd(uuid, dateStr);
                            }
                        }
                    });
                }
            },

            getLastSnapshotProgress(taskId) { if (!this.measurements || !this.measurements.length) return 0; const lastM = this.measurements[this.measurements.length - 1]; const item = lastM.items.find(i => i.uuid === taskId); return item ? parseFloat(item.progress) : 0; },
            updMeasurementDelta(taskId, deltaVal, previousTotal) { let delta = parseFloat(deltaVal) || 0; let newTotal = previousTotal + delta; if (newTotal > 100) { newTotal = 100; delta = 100 - previousTotal; } if (newTotal < 0) { newTotal = 0; } this.db.find(t => t.uuid === taskId).progress = newTotal; this.recalc(); },
            renderG() {
                const tasks = []; let minDate = new Date(); this.db.forEach(t => { if (t.start && t.start < minDate.toISOString().split('T')[0]) minDate = new Date(t.start); });
                this.db.forEach((t, i) => { const isG = t.type === 'group' || this.db.some(c=>c.parent===t.uuid); const parent = this.db.find(p => p.uuid === t.parent); if (!isG && parent && parent.collapsed) return; let css = 'bar-risk-low'; let start = t.start; let end = t.end; if (!start || !end) { start = new Date().toISOString().split('T')[0]; end = start; css = 'bar-invisible'; } else { if (isG) css = 'bar-group'; else { const today = new Date().toISOString().split('T')[0]; if (t.critical) css = 'bar-risk-critical'; else if (t.end < today && t.progress < 100) css = 'bar-risk-high'; else if (t.progress === 100) css = 'bar-risk-ok'; else css = 'bar-risk-med'; } } tasks.push({ id: t.uuid, name: t.name, start: start, end: end, progress: t.progress || 0, dependencies: (t.pred || []).join(','), custom_class: css, _cost: t.cost || 0, _dur: t.duration || 0 }); });
                document.getElementById('gantt-box').innerHTML = '';
                if (tasks.length) {
                    const startView = new Date(minDate); startView.setDate(startView.getDate() - 5);
                    this.ganttInst = new Gantt("#gantt-box", tasks, { 
                        view_mode: this.ganttViewMode, 
                        language: 'ptBr', 
                        bar_height: 25, 
                        padding: 15,
                        header_height: 50,
                        custom_popup_html: function(task) { const start = new Date(task.start).toLocaleDateString(); const end = new Date(task.end).toLocaleDateString(); const cost = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(task._cost); return `<div class="bg-slate-800 text-white text-[10px] p-3 rounded-lg shadow-xl w-48 relative z-50 opacity-95"><div class="font-black uppercase text-blue-400 mb-1">${task.name}</div><div class="grid grid-cols-2 gap-1 mb-2 text-slate-300"><span>Início:</span> <span class="text-right text-white font-bold">${start}</span><span>Fim:</span> <span class="text-right text-white font-bold">${end}</span><span>Duração:</span> <span class="text-right text-white font-bold">${task._dur} d</span><span>Custo:</span> <span class="text-right text-white font-bold">${cost}</span></div><div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden"><div class="bg-blue-500 h-full" style="width: ${task.progress}%"></div></div><div class="text-center mt-1 font-black">${task.progress}% Concluído</div></div>`; } 
                    });
                    setTimeout(() => { const svg = document.querySelector('#gantt-box svg'); if (!svg) return; this.db.forEach(t => { if (t.baseStart && t.baseEnd) { const taskGroup = svg.querySelector(`.bar-wrapper[data-id="${t.uuid}"]`); if (taskGroup) { const rect = taskGroup.querySelector('.bar'); if (rect && !taskGroup.classList.contains('bar-invisible')) { const start = new Date(t.start); const baseStart = new Date(t.baseStart); const baseEnd = new Date(t.baseEnd); const durationDays = (new Date(t.end) - start) / (1000 * 60 * 60 * 24); const baseDurationDays = (baseEnd - baseStart) / (1000 * 60 * 60 * 24); const diffDays = (baseStart - start) / (1000 * 60 * 60 * 24); if (durationDays > 0) { const currentWidth = parseFloat(rect.getAttribute("width")); const pxPerDay = currentWidth / Math.max(1, durationDays); const baseX = parseFloat(rect.getAttribute("x")) + (diffDays * pxPerDay); const baseWidth = Math.max(1, baseDurationDays * pxPerDay); const baseRect = document.createElementNS("http://www.w3.org/2000/svg", "rect"); baseRect.setAttribute("x", baseX); baseRect.setAttribute("y", parseFloat(rect.getAttribute("y")) + 12); baseRect.setAttribute("width", baseWidth); baseRect.setAttribute("height", "4"); baseRect.setAttribute("class", "baseline-bar"); taskGroup.appendChild(baseRect); } } } } }); }, 500);
                }
            },
            renderDash() {
                if (!document.getElementById('pie-chart')) return; if (this.charts.pie) { this.charts.pie.destroy(); this.charts.pie = null; } if (this.charts.scurve) { this.charts.scurve.destroy(); this.charts.scurve = null; }
                const tot = this.db.reduce((a, t) => a + (t.type === 'item' ? 1 : 0), 0); const done = this.db.reduce((a, t) => a + (t.type === 'item' && t.progress == 100 ? 1 : 0), 0); const cost = this.db.reduce((a, t) => a + (t.type === 'item' ? (parseFloat(t.cost) || 0) : 0), 0); const prog = tot ? Math.round((done / tot) * 100) : 0; const measCount = this.measurements ? this.measurements.length : 0;
                document.getElementById('dash-kpi').innerHTML = `<div class="bg-blue-600 text-white p-6 rounded-[30px] shadow-lg"><h2 class="text-4xl font-black">${prog}%</h2><p class="text-[10px] opacity-70 uppercase">Global</p></div><div class="bg-white border p-6 rounded-[30px]"><h2 class="text-xl font-black text-slate-700">${fmt(cost)}</h2><p class="text-[10px] text-slate-400 uppercase">Orçamento</p></div><div class="bg-white border p-6 rounded-[30px]"><h2 class="text-xl font-black text-green-600">${done}/${tot}</h2><p class="text-[10px] text-slate-400 uppercase">Tarefas</p></div><div class="bg-white border p-6 rounded-[30px]"><h2 class="text-xl font-black text-purple-500">${measCount}</h2><p class="text-[10px] text-slate-400 uppercase">Medições</p></div>`;
                const ctxPie = document.getElementById('pie-chart'); const ctxS = document.getElementById('scurve-chart');
                if (ctxPie && ctxS) {
                    this.charts.pie = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['Concluído', 'Pendente'], datasets: [{ data: [done, tot - done], backgroundColor: ['#22c55e', '#e2e8f0'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                    const items = this.db.filter(t => t.type === 'item' && t.start && t.end && t.cost > 0); let labels = []; let dataPlanned = [];
                    if (items.length > 0) { const allDates = items.map(t => [new Date(t.start), new Date(t.end)]).flat().sort((a, b) => a - b); const minD = new Date(allDates[0]); const maxD = new Date(allDates[allDates.length - 1]); let curr = new Date(minD.getFullYear(), minD.getMonth(), 1); const endPoint = new Date(maxD.getFullYear(), maxD.getMonth() + 1, 1); while (curr <= endPoint) { labels.push(curr.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' })); let accum = 0; items.forEach(t => { const s = new Date(t.start); const e = new Date(t.end); const c = parseFloat(t.cost); if (curr >= e) { accum += c; } else if (curr > s) { const totalDur = (e - s); const elapsed = (curr - s); let pct = elapsed / totalDur; if (pct > 1) pct = 1; accum += c * pct; } }); dataPlanned.push(accum); curr.setMonth(curr.getMonth() + 1); } }
                    this.charts.scurve = new Chart(ctxS, { type: 'line', data: { labels: labels.length ? labels : ['Início', 'Fim'], datasets: [{ label: 'Planejado Acumulado (R$)', data: dataPlanned.length ? dataPlanned : [0, cost], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 2 }] }, options: { maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: function(context) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.raw); } } } } } });
                }
                this.generateNarrative();
            },
            generateNarrative() { const el = document.getElementById('ai-narrative-content'); if (!el) return; const tot = this.db.reduce((a, t) => a + (t.type === 'item' ? 1 : 0), 0); if (tot === 0) { el.innerHTML = "Adicione tarefas."; return; } const done = this.db.reduce((a, t) => a + (t.type === 'item' && t.progress == 100 ? 1 : 0), 0); const progGlobal = Math.round((done / tot) * 100); const today = new Date(); let activeItems = 0; let plannedAccum = 0; this.db.forEach(t => { if (t.type === 'item' && t.start && t.end) { const s = new Date(t.start); const e = new Date(t.end); if (today >= s) { activeItems++; const totalDur = (e - s); const elapsed = (today - s); let expected = (elapsed / totalDur) * 100; if (expected > 100) expected = 100; plannedAccum += expected; } } }); const plannedAvg = activeItems ? (plannedAccum / activeItems) : 0; const deviation = progGlobal - plannedAvg; let narrative = ""; if (deviation < -10) narrative = `<p><strong class="text-red-600">Alerta:</strong> Atraso de <strong>${Math.round(Math.abs(deviation))}%</strong>.</p>`; else if (deviation < 0) narrative = `<p><strong class="text-orange-500">Atenção:</strong> Desvio de <strong>${Math.round(Math.abs(deviation))}%</strong>.</p>`; else narrative = `<p><strong class="text-green-600">Excelente:</strong> Obra em dia.</p>`; el.innerHTML = narrative; },
            
            openSnapshots() { document.getElementById('modal-snapshots').classList.add('active'); this.renderSnapshots(); },
            renderSnapshots() { const list = document.getElementById('snapshot-list'); if (this.snapshots.length === 0) { list.innerHTML = '<p class="text-slate-400 text-center text-xs">Nenhum snapshot.</p>'; return; } list.innerHTML = this.snapshots.map(s => `<div class="bg-slate-50 p-3 rounded border flex justify-between items-center mb-2"><div><p class="font-black text-slate-700 text-xs uppercase">${s.name}</p><p class="text-[9px] text-slate-400">${new Date(s.date).toLocaleString()}</p></div><div class="flex gap-2"><button onclick="editor.restoreSnapshot('${s.id}')" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[9px] font-bold hover:bg-indigo-200">RESTAURAR</button><button onclick="editor.deleteSnapshot('${s.id}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-3"></i></button></div></div>`).join(''); lucide.createIcons(); },
            createSnapshot() {
                const name = document.getElementById('snapshot-name').value;
                if (!name) return alert("Nome obrigatório");
                const snap = { id: 's' + Date.now(), name: name, date: new Date(), data: JSON.parse(JSON.stringify(this.db)), eap: JSON.parse(JSON.stringify(this.eap)), kb: JSON.parse(JSON.stringify(this.kb)) };
                this.snapshots.push(snap);
                document.getElementById('snapshot-name').value = '';
                this.autoSave();
                this.renderSnapshots();
                alert("Versão criada com sucesso.");
            },
            restoreSnapshot(sid) {
                const s = this.snapshots.find(x => x.id === sid);
                if (s && confirm(`Restaurar versão "${s.name}"? O estado atual será perdido.`)) {
                    this.db = JSON.parse(JSON.stringify(s.data));
                    this.eap = JSON.parse(JSON.stringify(s.eap));
                    this.kb = JSON.parse(JSON.stringify(s.kb));
                    this.recalc();
                    this.renderSnapshots();
                    this.renderEAP();
                    this.renderKanban();
                    alert("Projeto restaurado.");
                }
            },
            deleteSnapshot(sid) { if (confirm("Excluir versão?")) { this.snapshots = this.snapshots.filter(x => x.id !== sid); this.autoSave(); this.renderSnapshots(); } },

            renderCash() {
                const m={}; editor.financialBreakdown={};
                editor.db.forEach((t, index) => {
                    if (index === 0) return;
                    if (t.type === 'group' && t.start && t.cost > 0) {
                        const g = t;
                        const c=g.purchaseConfig||{mode:'standard',months:0,entry:0,installments:1};const s=new Date(g.start);if(c.mode==='custom'&&c.months>0)s.setMonth(s.getMonth()-c.months);let map=[];if(c.mode==='standard'){const e=new Date(g.end);const mo=Math.max(1,(e.getFullYear()-s.getFullYear())*12+(e.getMonth()-s.getMonth())+1);const v=g.cost/mo;for(let i=0;i<mo;i++)map.push([new Date(s.getFullYear(),s.getMonth()+i,1),v]);}else{const ev=g.cost*(c.entry/100);const iv=(g.cost-ev)/Math.max(1,c.installments);map.push([new Date(s),ev]);for(let i=1;i<=c.installments;i++)map.push([new Date(s.getFullYear(),s.getMonth()+i,1),iv]);}map.forEach(([d,v])=>{const k=d.toISOString().slice(0,7);m[k]=(m[k]||0)+v;if(!editor.financialBreakdown[k])editor.financialBreakdown[k]=[];editor.financialBreakdown[k].push({name:g.name,value:v});});
                    }
                });
                const l=Object.keys(m).sort();const d=l.map(k=>m[k]);if(editor.charts.cash)editor.charts.cash.destroy();editor.charts.cash=new Chart(document.getElementById('cash-chart'),{type:'bar',data:{labels:l,datasets:[{label:'Desembolso (R$)',data:d,backgroundColor:'#3b82f6'}]},options:{maintainAspectRatio:false,onClick:(e,el)=>{if(el.length>0)editor.showFinancialDetail(l[el[0].index]);}}});
            }, 
            showFinancialDetail(m) {const l=document.getElementById('finance-list');document.getElementById('finance-detail-title').innerText="Detalhamento: "+m;const i=editor.financialBreakdown[m]||[];l.innerHTML=i.map(x=>`<div class="flex justify-between items-center border-b pb-1 mb-1 last:border-0"><span class="text-xs text-slate-700 font-medium truncate w-2/3">${x.name}</span><span class="text-xs font-bold text-slate-900">${fmt(x.value)}</span></div>`).join('');document.getElementById('finance-total').innerText=fmt(i.reduce((a,c)=>a+c.value,0));document.getElementById('modal-finance-detail').classList.add('active');}, renderKanban() {const c={todo:document.getElementById('kb-todo'),doing:document.getElementById('kb-doing'),done:document.getElementById('kb-done')};Object.values(c).forEach(x=>{if(x)x.innerHTML='';});if(!editor.kb)return;editor.kb.forEach(k=>{const h=`<div class="bg-white p-3 rounded-lg shadow mb-3 text-xs border-l-4 ${k.status==='todo'?'border-slate-400':k.status==='doing'?'border-blue-500':'border-green-500'} animate-fade-in"><textarea onchange="editor.updKb('${k.uuid}',this.value)" class="w-full font-bold outline-none resize-none bg-transparent hover:bg-slate-50 focus:bg-white rounded p-1 transition" rows="2">${k.title}</textarea><div class="flex justify-end gap-1 mt-2 opacity-50 hover:opacity-100 transition"><button onclick="editor.moveKb('${k.uuid}','todo')" class="w-5 h-5 bg-slate-100 rounded text-[9px]">1</button><button onclick="editor.moveKb('${k.uuid}','doing')" class="w-5 h-5 bg-blue-100 rounded text-[9px]">2</button><button onclick="editor.moveKb('${k.uuid}','done')" class="w-5 h-5 bg-green-100 rounded text-[9px]">3</button><button onclick="editor.remKb('${k.uuid}')" class="text-red-400 w-5 h-5">x</button></div></div>`;if(c[k.status])c[k.status].innerHTML+=h;});}, addKb(s) {if(!editor.kb)editor.kb=[];editor.kb.push({uuid:'k'+Date.now(),title:'Tarefa',status:s});editor.renderKanban();editor.autoSave();}, updKb(u,v) {const i=editor.kb.find(x=>x.uuid===u);if(i){i.title=v;editor.autoSave();}}, moveKb(u,s) {const i=editor.kb.find(x=>x.uuid===u);if(i){i.status=s;editor.renderKanban();editor.autoSave();}}, remKb(u) {if(confirm("Del?")){editor.kb=editor.kb.filter(x=>x.uuid!==u);editor.renderKanban();editor.autoSave();}}, renderBalance() {if(!editor.db.length)return;if(editor.charts.bal)editor.charts.bal.destroy();const u=[...new Set(editor.db.filter(t=>t.type==='item').map(t=>t.name))];const ds=editor.db.filter(t=>t.type==='group').map((g,i)=>({label:g.name,data:editor.db.filter(t=>t.parent===g.uuid&&t.progress<100).map(t=>({x:t.start,y:u.indexOf(t.name)+1})).sort((a,b)=>new Date(a.x)-new Date(b.x)),borderColor:`hsl(${i*40},70%,50%)`,showLine:true}));const ctx=document.getElementById('balance-chart').getContext('2d');editor.charts.bal=new Chart(ctx,{type:'scatter',data:{datasets:ds},options:{maintainAspectRatio:false,scales:{x:{type:'time',time:{unit:'day'}},y:{ticks:{callback:v=>u[v-1]}}}}});editor.analyzeFlow();}, analyzeFlow() {const a=[];const g=editor.db.filter(t=>t.type==='group'&&t.start&&t.end).sort((a,b)=>new Date(a.start)-new Date(b.start));for(let i=0;i<g.length-1;i++){const c=g[i],n=g[i+1];const dc=(new Date(c.end)-new Date(c.start))/(864e5),dn=(new Date(n.end)-new Date(n.start))/(864e5);if(dn<dc&&new Date(n.start)>new Date(c.start))a.push(`<div class="bg-red-50 p-2 rounded border border-red-100 text-[10px] text-red-700 font-bold">⚠️ Choque: ${n.name} > ${c.name}.</div>`);const gap=(new Date(n.start)-new Date(c.end))/(864e5);if(gap>5)a.push(`<div class="bg-yellow-50 p-2 rounded border border-yellow-100 text-[10px] text-yellow-700 font-bold">💤 Gap: ${Math.round(gap)}d entre ${c.name} e ${n.name}.</div>`);}if(!a.length)a.push('<div class="text-green-600 text-xs font-bold">Fluxo otimizado.</div>');document.getElementById('lob-alerts').innerHTML=a.join('');}, toggleMode() {editor.mode=editor.mode==='planning'?'measurement':'planning';document.getElementById('mode-label').innerText=editor.mode==='planning'?'MODO PADRÃO':'MODO MEDIÇÃO';document.getElementById('measurement-controls').className=editor.mode==='measurement'?'flex gap-2 ml-2 animate-fade-in bg-slate-100 p-1 rounded-lg border border-slate-200':'hidden';editor.renderT();}, switchView(v) {document.querySelectorAll('.view').forEach(x=>x.classList.add('hidden'));document.getElementById('v-'+v).classList.remove('hidden');if(v==='main')setTimeout(()=>editor.setupSync(),200);if(v==='bal')setTimeout(()=>editor.renderBalance(),200);if(v==='cash')setTimeout(()=>editor.renderCash(),200);if(v==='dash')setTimeout(()=>editor.renderDash(),200);if(v==='site')editor.renderSiteView();if(v==='kanban')editor.renderKanban();if(v==='eap')editor.renderEAP();}, autoSave() {if(editor.curr && auth.ss.id !== 'local_admin'){const i=projectManager.all.findIndex(p=>p.id===editor.curr);if(i>-1){projectManager.all[i].data=editor.db;projectManager.all[i].eap=editor.eap;projectManager.all[i].kb=editor.kb;projectManager.all[i].cfg=editor.cfg;projectManager.all[i].measurements=editor.measurements;projectManager.all[i].baselines=editor.baselines;projectManager.all[i].snapshots=editor.snapshots;projectManager.save();}}}, saveBaseline() {const n=document.getElementById('new-baseline-name').value;if(!n)return alert("Nome necessário");const s={};editor.db.forEach(t=>{s[t.uuid]={start:t.start,end:t.end};});editor.baselines.push({id:'b'+Date.now(),name:n,date:new Date().toISOString(),items:s});document.getElementById('new-baseline-name').value='';editor.renderBaselineList();editor.autoSave();projectManager.save();alert('Baseline salva!');}, renderBaselineList() {const l=document.getElementById('baseline-list');l.innerHTML=editor.baselines.map(b=>`<div class="flex justify-between items-center bg-slate-50 p-2 mb-1 rounded border"><div><span class="font-bold text-[10px] text-slate-700 uppercase block">${b.name}</span><span class="text-[8px] text-slate-400">${new Date(b.date).toLocaleDateString()}</span></div><div class="flex gap-1"><button onclick="editor.applyBaseline('${b.id}')" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-[9px] font-bold hover:bg-blue-200">APLICAR</button><button onclick="editor.deleteBaseline('${b.id}')" class="text-red-400 hover:text-red-600 px-1 font-bold">x</button></div></div>`).join('');if(!editor.baselines.length)l.innerHTML='<p class="text-[9px] text-center text-slate-400">Vazio</p>';}, applyBaseline(bid) {const bl=editor.baselines.find(b=>b.id===bid);if(bl){editor.db.forEach(t=>{if(bl.items[t.uuid]){t.baseStart=bl.items[t.uuid].start;t.baseEnd=bl.items[t.uuid].end;}});editor.recalc();alert('Aplicado!');}}, deleteBaseline(bid) {if(confirm("Excluir?")){editor.baselines=editor.baselines.filter(b=>b.id!==bid);editor.renderBaselineList();editor.autoSave();}}, openPurchaseModal(gid) {editor.editingGroup=gid;const g=editor.db.find(x=>x.uuid===gid);document.getElementById('modal-purchase').classList.add('active');document.getElementById('modal-purchase-title').innerText=g.name;const c=g.purchaseConfig||{mode:'standard',months:0,entry:0,installments:1};document.getElementById('p-months').value=c.months;document.getElementById('p-entry').value=c.entry;document.getElementById('p-installments').value=c.installments;editor.setPurchaseMode(c.mode);}, setPurchaseMode(m) {editor.tempPurchaseMode=m;document.getElementById('panel-p-standard').className=m==='standard'?'block text-center py-4 text-[10px] text-slate-500':'hidden';document.getElementById('panel-p-custom').className=m==='custom'?'block space-y-3':'hidden';document.getElementById('btn-p-standard').className=`flex-1 py-2 rounded-md text-[10px] font-black uppercase ${m==='standard'?'bg-purple-600 text-white':'bg-slate-200'}`;document.getElementById('btn-p-custom').className=`flex-1 py-2 rounded-md text-[10px] font-black uppercase ${m==='custom'?'bg-purple-600 text-white':'bg-slate-200'}`;}, savePurchase() {const g=editor.db.find(x=>x.uuid===editor.editingGroup);g.purchaseConfig={mode:editor.tempPurchaseMode,months:parseInt(document.getElementById('p-months').value)||0,entry:parseFloat(document.getElementById('p-entry').value)||0,installments:parseInt(document.getElementById('p-installments').value)||1};document.getElementById('modal-purchase').classList.remove('active');editor.autoSave();}, openConfig() {document.getElementById('modal-config').classList.add('active');document.getElementById('cfg-sat').checked=editor.cfg.sat;document.getElementById('cfg-sun').checked=editor.cfg.sun;editor.renderHolidays();editor.renderBaselineList();}, saveConfig() {editor.cfg.sat=document.getElementById('cfg-sat').checked;editor.cfg.sun=document.getElementById('cfg-sun').checked;document.getElementById('modal-config').classList.remove('active');editor.recalc();}, addHoliday() {const h=document.getElementById('new-holiday').value;if(h){editor.cfg.holidays=editor.cfg.holidays||[];editor.cfg.holidays.push(h);editor.renderHolidays();}}, renderHolidays() {document.getElementById('holiday-list').innerHTML=(editor.cfg.holidays||[]).map(h=>`<div>${h}</div>`).join('');},
            
            recalculateSchedule() {
                if(!editor.measurements.length) return alert("Sem medições para basear o recálculo.");
                
                const sorted = [...editor.measurements].sort((a,b) => new Date(b.date) - new Date(a.date));
                const lastMeas = sorted[0];
                const lastDate = new Date(lastMeas.date).toISOString().split('T')[0];
                const restartDate = editor.getNextWorkDay(lastDate);

                if(!confirm(`Reprogramar saldo a partir de ${new Date(restartDate).toLocaleDateString()} (Dia seguinte à última medição)?`)) return;

                let changes = 0;
                editor.db.forEach(t => {
                    if (t.type === 'item' && t.progress < 100) {
                        const totalDuration = parseInt(t.duration) || 1;
                        const remainingPct = (100 - t.progress) / 100;
                        const remainingDays = Math.ceil(totalDuration * remainingPct);
                        
                        if (remainingDays > 0) {
                            const newEnd = editor.addWorkDays(restartDate, remainingDays);
                            if (newEnd > t.end) {
                                t.end = newEnd;
                                t.duration = editor.getDuration(t.start, t.end);
                                changes++;
                            }
                        }
                    }
                });

                if(changes > 0) {
                    alert(`${changes} tarefas reprogramadas.`);
                    editor.recalc();
                } else {
                    alert("Nenhuma tarefa precisou ser adiada.");
                }
            }
        };

        const router = { go(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById('page-' + id).classList.add('active'); lucide.createIcons(); } };
        
        const projectManager = {
            all: [],
            async load() { 
                if (auth.ss.id === 'local_admin') {
                    this.all = []; 
                    return;
                }
                const r = await fetch(`${FB}db_${auth.ss.id}.json`); 
                this.all = await r.json() || []; 
                this.render(); 
            },
            render() { document.getElementById('grid-projects').innerHTML = this.all.map(p => `<div class="relative group bg-white p-8 rounded-[30px] border hover:border-blue-500 shadow-sm hover:shadow-md transition flex flex-col justify-between h-40"><div onclick="editor.open('${p.id}')" class="cursor-pointer"><h3 class="font-black uppercase text-xs text-slate-800">${p.name}</h3><p class="text-[10px] text-slate-400 mt-2">ID: ${p.id}</p></div><div class="flex justify-between items-end"><button onclick="projectManager.exportProject('${p.id}')" class="text-blue-500 text-[10px] font-bold hover:underline flex gap-1 items-center"><i data-lucide="download" class="w-3"></i> JSON</button><button onclick="projectManager.duplicate('${p.id}')" class="text-purple-500 text-[10px] font-bold hover:underline flex gap-1 items-center ml-2"><i data-lucide="copy" class="w-3"></i> Duplicar</button><button onclick="event.stopPropagation(); projectManager.del('${p.id}')" class="text-red-200 hover:text-red-500"><i data-lucide="trash-2" class="w-4"></i></button></div></div>`).join(''); lucide.createIcons(); },
            async save() { 
                if (auth.ss.id === 'local_admin') return; 
                await fetch(`${FB}db_${auth.ss.id}.json`, { method: 'PUT', body: JSON.stringify(this.all) }); 
            },
            openCreateSelection() { document.getElementById('modal-create-type').classList.add('active'); },
            createManual() { document.getElementById('modal-create-type').classList.remove('active'); const n = prompt('Nome do Projeto:'); if (n) { const rootId = 'g' + Date.now(); this.all.push({ id: 'p' + Date.now(), name: n, data: [{ uuid: rootId, name: 'RESUMO DO PROJETO', type: 'group', parent: 'root', cost: 0, progress: 0, collapsed: false }], eap: [], kb: [], measurements: [], baselines: [], snapshots: [] }); this.save(); this.render(); } },
            createWizard() { document.getElementById('modal-create-type').classList.remove('active'); document.getElementById('cp-name').value = ''; document.getElementById('cp-start').value = new Date().toISOString().split('T')[0]; document.getElementById('modal-create-project').classList.add('active'); },
            generateAndSave() {
                const name = document.getElementById('cp-name').value;
                if (!name) return alert("Nome é obrigatório");
                
                const start = document.getElementById('cp-start').value;
                const subs = parseInt(document.getElementById('cp-subs').value) || 0;
                const hasGround = document.getElementById('cp-ground').checked;
                const garages = parseInt(document.getElementById('cp-garage').value) || 0;
                const hasLazer = document.getElementById('cp-lazer').checked;
                const tipo = parseInt(document.getElementById('cp-tipo').value) || 1;
                const hasRooftop = document.getElementById('cp-rooftop').checked;
                const hasWater = document.getElementById('cp-water').checked;

                const db = [];
                const rootId = 'root_' + Date.now();
                db.push({ uuid: rootId, name: 'RESUMO DO PROJETO', type: 'group', parent: 'root', cost: 0, progress: 0, collapsed: false, start: start, end: start });

                let floors = [];
                let floorIndex = -subs; 
                
                for (let i = subs; i >= 1; i--) { floors.push({ name: `${floorIndex}º Pavimento - Subsolo ${i}`, type: 'sub' }); floorIndex++; }
                if (hasGround) { floors.push({ name: `0º Pavimento - Térreo`, type: 'ground' }); floorIndex = 1; } else if(floorIndex === 0) { floorIndex = 1; }
                for (let i = 1; i <= garages; i++) { floors.push({ name: `${floorIndex}º Pavimento - Garagem ${i}`, type: 'garage' }); floorIndex++; }
                if (hasLazer) { floors.push({ name: `${floorIndex}º Pavimento - Lazer/PUC`, type: 'lazer' }); floorIndex++; }
                for (let i = 1; i <= tipo; i++) { floors.push({ name: `${floorIndex}º Pavimento - Tipo ${i}`, type: 'tipo' }); floorIndex++; }
                if(hasRooftop) floors.push({ name: `Cobertura / Rooftop`, type: 'roof' });
                if(hasWater) floors.push({ name: `Barrilete / Caixa D'água`, type: 'water' });

                const createdTasks = {};

                const addTask = (serviceName, floorIndex, itemName, duration, preds = []) => {
                    if (!createdTasks[serviceName]) createdTasks[serviceName] = [];
                    const tid = 't' + Date.now() + Math.random().toString(36).substr(2, 5);
                    createdTasks[serviceName][floorIndex] = tid;
                    
                    let gid = null;
                    const existingGroup = db.find(x => x.name === serviceName && x.type === 'group');
                    if (existingGroup) {
                        gid = existingGroup.uuid;
                    } else {
                        gid = 'g' + Date.now() + Math.random().toString(36).substr(2, 5);
                        db.push({ uuid: gid, name: serviceName, type: 'group', parent: rootId, cost: 0, progress: 0, collapsed: false });
                    }
                    let estStart = start;
                    db.push({ uuid: tid, name: itemName, type: 'item', parent: gid, duration: duration, start: estStart, end: estStart, progress: 0, cost: 0, pred: preds });
                    return tid;
                };

                const tPrelim = addTask('SERVIÇOS PRELIMINARES', 0, 'Mobilização e Canteiro', 15);
                const tTerra = addTask('MOVIMENTAÇÃO DE TERRA', 0, 'Escavação e Contenção', 20, [tPrelim]);
                const tFund = addTask('FUNDAÇÃO', 0, 'Infraestrutura (Estacas/Blocos)', 30, [tTerra]);

                floors.forEach((f, i) => {
                    let preds = [];
                    if (i === 0) preds.push(tFund); 
                    else if(createdTasks['ESTRUTURA - VIGAS E LAJES'] && createdTasks['ESTRUTURA - VIGAS E LAJES'][i-1]) preds.push(createdTasks['ESTRUTURA - VIGAS E LAJES'][i-1]);
                    addTask('ESTRUTURA - PILARES', i, f.name, 5, preds);
                });

                floors.forEach((f, i) => {
                    let preds = [];
                    if(createdTasks['ESTRUTURA - PILARES'][i]) preds.push(createdTasks['ESTRUTURA - PILARES'][i]);
                    addTask('ESTRUTURA - VIGAS E LAJES', i, f.name, 7, preds);
                });

                floors.forEach((f, i) => {
                    let preds = [];
                    if (i > 0 && createdTasks['ALVENARIA E VEDAÇÃO'][i-1]) preds.push(createdTasks['ALVENARIA E VEDAÇÃO'][i-1]);
                    const targetStructFloor = i + 3;
                    if (targetStructFloor < floors.length) { if(createdTasks['ESTRUTURA - VIGAS E LAJES'][targetStructFloor]) preds.push(createdTasks['ESTRUTURA - VIGAS E LAJES'][targetStructFloor]); } 
                    else { const lastLajeIndex = floors.length - 1; if(createdTasks['ESTRUTURA - VIGAS E LAJES'][lastLajeIndex]) preds.push(createdTasks['ESTRUTURA - VIGAS E LAJES'][lastLajeIndex]); }
                    addTask('ALVENARIA E VEDAÇÃO', i, f.name, 10, preds);
                });

                floors.forEach((f, i) => {
                    const pAlv = createdTasks['ALVENARIA E VEDAÇÃO'][i];
                    addTask('INSTALAÇÕES HIDRÁULICAS', i, f.name, 5, [pAlv]);
                    addTask('INSTALAÇÕES ELÉTRICAS', i, f.name, 5, [pAlv]);
                    addTask('INFRA ELÉTRICA/AR', i, f.name, 5, [pAlv]);
                });

                floors.forEach((f, i) => {
                    const pInfra = createdTasks['INFRA ELÉTRICA/AR'][i];
                    addTask('REVESTIMENTO EM ARGAMASSA', i, f.name, 10, [pInfra]);
                });

                floors.forEach((f, i) => {
                    const pReboco = createdTasks['REVESTIMENTO EM ARGAMASSA'][i];
                    addTask('CONTRAPISO', i, f.name, 5, [pReboco]);
                });

                floors.forEach((f, i) => {
                    const pReboco = createdTasks['REVESTIMENTO EM ARGAMASSA'][i];
                    addTask('REVESTIMENTO CERÂMICO (PAREDE)', i, f.name, 7, [pReboco]);
                });

                floors.forEach((f, i) => {
                    const pCeram = createdTasks['REVESTIMENTO CERÂMICO (PAREDE)'][i];
                    addTask('FIAÇÃO ELÉTRICA', i, f.name, 5, [pCeram]);
                });

                floors.forEach((f, i) => {
                    const pFiacao = createdTasks['FIAÇÃO ELÉTRICA'][i];
                    addTask('FORROS', i, f.name, 5, [pFiacao]);
                });

                floors.forEach((f, i) => {
                    const pForro = createdTasks['FORROS'][i];
                    addTask('PISO CERÂMICO', i, f.name, 7, [pForro]);
                });

                floors.forEach((f, i) => {
                    const pPiso = createdTasks['PISO CERÂMICO'][i];
                    addTask('PINTURA', i, f.name, 10, [pPiso]);
                    addTask('PORTAS DE MADEIRA', i, f.name, 5, [pPiso]); 
                    addTask('ESQUADRIAS', i, f.name, 5, [pPiso]);
                    addTask('LOUÇAS E METAIS', i, f.name, 3, [pPiso]);
                });

                const lastPaint = createdTasks['PINTURA'][floors.length - 1];
                addTask('ELEVADORES', 0, 'Instalação Global', 30, [lastPaint]); 
                addTask('URBANIZAÇÃO E ÁREAS EXTERNAS', 0, 'Geral', 20, [lastPaint]);
                addTask('LIMPEZA FINAL E ENTREGA', 0, 'Entrega', 10, [createdTasks['URBANIZAÇÃO E ÁREAS EXTERNAS'][0]]);

                this.all.push({ id: 'p' + Date.now(), name: name, data: db, eap: [], kb: [], measurements: [], baselines: [], snapshots: [] });
                this.save();
                this.render();
                document.getElementById('modal-create-project').classList.remove('active');
            },
            async del(id) { if (confirm("ATENÇÃO: Isso excluirá todo o projeto permanentemente. Continuar?")) { this.all = this.all.filter(p => p.id !== id); await this.save(); this.render(); } },
            exportProject(id) {const p=this.all.find(x=>x.id===id);if(!p)return;const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(p));const a=document.createElement('a');a.setAttribute("href",dataStr);a.setAttribute("download",`bravo_project_${p.name.replace(/\s+/g,'_')}.json`);document.body.appendChild(a);a.click();a.remove();},
            duplicate(id) {const p=this.all.find(x=>x.id===id);if(!p)return;const copy=JSON.parse(JSON.stringify(p));copy.id='p'+Date.now();copy.name=copy.name+" (Cópia)";this.all.push(copy);this.save();this.render();},
            importFile(input) {const file=input.files[0];if(!file)return;const reader=new FileReader();reader.onload=async(e)=>{try{const json=JSON.parse(e.target.result);if(!json.id||!json.data)throw new Error("Arquivo inválido");json.id='p'+Date.now();json.name=json.name+" (Importado)";this.all.push(json);await this.save();this.render();alert("Projeto importado com sucesso!");}catch(err){alert("Erro ao importar: "+err.message);}};reader.readAsText(file);input.value='';}
        };
    </script>
</body>
</html>