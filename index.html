<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivisPRO Cloud - Bravo Civil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; overflow: hidden; }
        .page { display: none; width: 100vw; height: 100vh; overflow-y: auto; position: absolute; }
        .page.active { display: block; }
        .row-master { background: #0f172a !important; color: white !important; font-weight: 800; }
        .row-group { background: #f1f5f9 !important; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
        .input-cell { background: transparent; width: 100%; outline: none; padding: 4px; border-radius: 4px; border: 1px solid transparent; }
        .input-cell:focus { border-color: #3b82f6; background: white; }
        .kpi-card { background: white; padding: 1.25rem; border-radius: 1.5rem; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

    <div id="page-login" class="page active flex items-center justify-center bg-slate-900">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-full max-w-md text-center">
            <h1 class="text-4xl font-black italic mb-2">Bravo<span class="text-blue-600">CIVIL</span></h1>
            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-widest mb-8">Controle de Engenharia Cloud</p>
            
            <div class="bg-blue-50 p-4 rounded-2xl mb-6 text-left">
                <label class="text-[9px] font-black uppercase text-blue-400 italic">Endpoint Firebase RTDB</label>
                <input type="text" id="fb-url" class="w-full bg-transparent border-none outline-none text-sm font-bold text-blue-900" 
                value="https://bravo-civil-default-rtdb.firebaseio.com/">
            </div>

            <button onclick="cloud.connect()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition-all scale-100 active:scale-95">CONECTAR AO BANCO</button>
        </div>
    </div>

    <div id="page-manager" class="page bg-slate-50">
        <nav class="bg-white border-b px-8 py-4 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-black italic">Bravo<span class="text-blue-600">CIVIL</span></h1>
                <div id="sync-indicator" class="flex items-center gap-2 text-[9px] font-black px-3 py-1 rounded-full bg-emerald-100 text-emerald-600 uppercase">
                    <i data-lucide="check-circle-2" class="w-3 h-3"></i> Nuvem Sincronizada
                </div>
            </div>
            <button onclick="projectManager.create()" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-700">+ NOVO EMPREENDIMENTO</button>
        </nav>
        <div class="max-w-6xl mx-auto p-12">
            <h2 class="text-2xl font-black mb-8 text-slate-800 uppercase tracking-tight">Projetos em Nuvem</h2>
            <div id="project-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
        </div>
    </div>

    <div id="page-editor" class="page bg-white">
        <header class="bg-slate-900 text-white px-6 py-3 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <button onclick="router.go('manager')" class="p-2 hover:bg-slate-800 rounded-lg"><i data-lucide="arrow-left"></i></button>
                <h2 id="edit-project-name" class="font-black">Editor</h2>
            </div>
            <div class="flex bg-slate-800 p-1 rounded-2xl">
                <button onclick="editor.switch('table')" id="tab-table" class="px-6 py-2 text-[10px] font-black uppercase rounded-xl bg-blue-600">Planilha</button>
                <button onclick="editor.switch('dash')" id="tab-dash" class="px-6 py-2 text-[10px] font-black uppercase rounded-xl">Dashboard</button>
            </div>
            <button onclick="window.print()" class="bg-slate-700 px-4 py-2 rounded-xl text-[10px] font-bold uppercase hover:bg-slate-600">PDF</button>
        </header>

        <main class="p-6 h-[calc(100vh-64px)] overflow-y-auto">
            <div id="view-table" class="editor-view">
                <div class="flex justify-between mb-4">
                    <div class="flex gap-2">
                        <button onclick="editor.toggleAll(false)" class="bg-slate-100 text-[10px] px-4 py-2 rounded-lg font-bold uppercase">Recolher</button>
                        <button onclick="editor.toggleAll(true)" class="bg-slate-100 text-[10px] px-4 py-2 rounded-lg font-bold uppercase">Expandir</button>
                    </div>
                    <button onclick="editor.addGroup()" class="bg-blue-600 text-white text-[10px] px-6 py-2.5 rounded-xl font-black">+ ADICIONAR ETAPA</button>
                </div>
                <table class="w-full text-sm border-collapse">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400 border-b">
                        <tr>
                            <th class="p-4 w-12">ID</th>
                            <th class="p-4 text-left">Tarefa</th>
                            <th class="p-4 w-32 text-right">Custo (R$)</th>
                            <th class="p-4 w-16 text-center">%</th>
                            <th class="p-4 w-32 text-center">Início</th>
                            <th class="p-4 w-16 text-center">Dias</th>
                            <th class="p-4 w-32 text-center">Fim</th>
                            <th class="p-4 w-16 text-center">Pred.</th>
                            <th class="p-4 w-12"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>

            <div id="view-dash" class="editor-view hidden">
                <div id="dash-kpis" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"></div>
                <div class="grid grid-cols-3 gap-6">
                    <div class="col-span-2 bg-white p-8 border rounded-[32px] h-[400px]">
                        <canvas id="scurve-canvas"></canvas>
                    </div>
                    <div class="bg-slate-900 p-8 rounded-[32px] text-white">
                        <h3 class="text-xs font-black text-slate-500 uppercase mb-6">Status Gerencial</h3>
                        <div id="dash-status-text"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- LOGICA DE NUVEM ---
        const cloud = {
            url: '',
            async connect() {
                let inputUrl = document.getElementById('fb-url').value;
                if(!inputUrl.includes('firebaseio.com')) return alert("Use a URL .firebaseio.com");
                this.url = inputUrl.endsWith('/') ? inputUrl : inputUrl + '/';
                localStorage.setItem('bravo_fb_url', this.url);
                await this.pull();
                router.go('manager');
            },
            async push() {
                const indicator = document.getElementById('sync-indicator');
                indicator.innerHTML = '<i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i> Sincronizando...';
                indicator.classList.replace('bg-emerald-100', 'bg-blue-100');
                indicator.classList.replace('text-emerald-600', 'text-blue-600');
                
                try {
                    await fetch(`${this.url}projects.json`, {
                        method: 'PUT',
                        body: JSON.stringify(projectManager.projects)
                    });
                    indicator.innerHTML = '<i data-lucide="check-circle-2" class="w-3 h-3"></i> Nuvem Sincronizada';
                    indicator.classList.replace('bg-blue-100', 'bg-emerald-100');
                    indicator.classList.replace('text-blue-600', 'text-emerald-600');
                } catch (e) { alert("Erro ao salvar na nuvem!"); }
                lucide.createIcons();
            },
            async pull() {
                try {
                    const res = await fetch(`${this.url}projects.json`);
                    const data = await res.json();
                    if(data) projectManager.projects = data;
                } catch (e) { console.error("Banco vazio"); }
            }
        };

        const router = {
            go(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('page-'+id).classList.add('active');
                if(id === 'manager') projectManager.render();
                lucide.createIcons();
            }
        };

        const projectManager = {
            projects: [],
            render() {
                const grid = document.getElementById('project-grid');
                grid.innerHTML = '';
                this.projects.forEach(p => {
                    grid.innerHTML += `
                    <div class="bg-white p-8 rounded-[32px] border-2 border-transparent hover:border-blue-500 shadow-sm transition-all group cursor-pointer" onclick="editor.open('${p.id}')">
                        <div class="flex justify-between mb-4">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center"><i data-lucide="building-2"></i></div>
                            <button onclick="event.stopPropagation(); projectManager.delete('${p.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i data-lucide="trash-2"></i></button>
                        </div>
                        <h3 class="font-black text-xl mb-1">${p.name}</h3>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${p.progress}% Concluído</p>
                    </div>`;
                });
                lucide.createIcons();
            },
            create() {
                const n = prompt("Nome da Obra:"); if(!n) return;
                this.projects.push({ id: 'p'+Date.now(), name: n, progress: 0, config: {sat:false, sun:false}, data: [{uuid:'m', name:n.toUpperCase(), type:'master', progress:0, cost:0, start:new Date().toISOString().split('T')[0]}] });
                cloud.push(); this.render();
            },
            delete(id) { if(confirm("Excluir projeto permanentemente?")) { this.projects = this.projects.filter(x => x.id !== id); cloud.push(); this.render(); } }
        };

        const editor = {
            currId: null, db: [], cfg: {}, collapsed: new Set(), uuidMap: {}, indexMap: {},

            open(id) {
                this.currId = id;
                const p = projectManager.projects.find(x => x.id === id);
                this.db = p.data; this.cfg = p.config || {sat:false, sun:false};
                document.getElementById('edit-project-name').innerText = p.name;
                router.go('editor');
                this.recalc();
            },

            // ITEM 3 CORRIGIDO: Pular para linha de baixo no Enter
            handleEnter(e, rowIdx, colIdx) {
                if(e.key === "Enter") {
                    e.preventDefault();
                    const rows = document.querySelectorAll('#table-body tr');
                    const nextRow = rows[rowIdx + 1];
                    if(nextRow) {
                        const inputs = nextRow.querySelectorAll('input:not([disabled])');
                        if(inputs[colIdx]) inputs[colIdx].focus();
                    }
                }
            },

            addWorkDays(dateStr, days) {
                if(!dateStr || days === 0) return dateStr;
                let d = new Date(dateStr + "T00:00:00");
                let added = 0;
                while(added < days) {
                    d.setDate(d.getDate() + 1);
                    const day = d.getDay();
                    if(!((day === 0 && !this.cfg.sun) || (day === 6 && !this.cfg.sat))) added++;
                }
                return d.toISOString().split('T')[0];
            },

            recalc() {
                this.indexMap = {}; this.uuidMap = {};
                this.db.forEach((t, i) => { this.indexMap[i+1] = t.uuid; this.uuidMap[t.uuid] = i+1; });

                this.db.forEach(t => {
                    if(t.type === 'item') {
                        if(t.pred?.length) {
                            let last = "";
                            t.pred.forEach(pid => { const p = this.db.find(x => x.uuid === pid); if(p?.end > last) last = p.end; });
                            if(last) t.start = this.addWorkDays(last, 1);
                        }
                        if(t.start && t.duration) t.end = this.addWorkDays(t.start, t.duration);
                    }
                });

                this.db.filter(t => t.type === 'group').forEach(g => {
                    const kids = this.db.filter(k => k.parent === g.uuid);
                    if(kids.length) {
                        g.cost = kids.reduce((s, k) => s + (parseFloat(k.cost) || 0), 0);
                        g.progress = Math.round(kids.reduce((s, k) => s + (parseFloat(k.progress) || 0), 0) / kids.length);
                        const sts = kids.map(k => k.start).filter(Boolean).sort();
                        const eds = kids.map(k => k.end).filter(Boolean).sort().reverse();
                        if(sts.length) g.start = sts[0]; if(eds.length) g.end = eds[0];
                    }
                });

                const master = this.db.find(x => x.type === 'master');
                if(master) {
                    const groups = this.db.filter(x => x.type === 'group');
                    master.cost = groups.reduce((s, g) => s + (g.cost || 0), 0);
                    master.progress = Math.round(groups.reduce((s, g) => s + (g.progress || 0), 0) / (groups.length || 1));
                    master.start = groups.map(g => g.start).filter(Boolean).sort()[0];
                    master.end = groups.map(g => g.end).filter(Boolean).sort().reverse()[0];
                }
                this.renderTable();
                this.autoSave();
            },

            renderTable() {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                let vIdx = 0;
                this.db.forEach((t, i) => {
                    if(t.parent && this.collapsed.has(t.parent)) return;
                    const isM = t.type === 'master', isG = t.type === 'group';
                    const predVal = (t.pred || []).map(u => this.uuidMap[u]).join(',');
                    
                    tbody.innerHTML += `
                    <tr class="${isM?'row-master':isG?'row-group':''} border-b transition-colors">
                        <td class="p-3 text-center text-[10px] font-black opacity-30">${i+1}</td>
                        <td class="p-3 flex items-center gap-2">
                            ${isG ? `<button onclick="editor.toggle('${t.uuid}')"><i data-lucide="${this.collapsed.has(t.uuid)?'chevron-right':'chevron-down'}" class="w-4 h-4"></i></button>` : ''}
                            <input value="${t.name}" onkeydown="editor.handleEnter(event, ${vIdx}, 0)" onchange="editor.upd('${t.uuid}','name',this.value)" class="input-cell font-bold ${t.parent?'ml-6':''}">
                            ${isG ? `<button onclick="editor.addItem('${t.uuid}')" class="text-blue-600"><i data-lucide="plus" class="w-3 h-3"></i></button>` : ''}
                        </td>
                        <td class="p-3"><input type="number" value="${t.cost||0}" onkeydown="editor.handleEnter(event, ${vIdx}, 1)" onchange="editor.upd('${t.uuid}','cost',this.value)" class="input-cell text-right" ${!isM && !isG?'':'disabled'}></td>
                        <td class="p-3"><input type="number" value="${t.progress||0}" onkeydown="editor.handleEnter(event, ${vIdx}, 2)" onchange="editor.upd('${t.uuid}','progress',this.value)" class="input-cell text-center font-black" ${t.type==='item'?'':'disabled'}></td>
                        <td class="p-3"><input type="date" value="${t.start||''}" onkeydown="editor.handleEnter(event, ${vIdx}, 3)" onchange="editor.upd('${t.uuid}','start',this.value)" class="input-cell text-center" ${t.type==='item'?'':'disabled'}></td>
                        <td class="p-3"><input type="number" value="${t.duration||0}" onkeydown="editor.handleEnter(event, ${vIdx}, 4)" onchange="editor.upd('${t.uuid}','duration',this.value)" class="input-cell text-center" ${t.type==='item'?'':'disabled'}></td>
                        <td class="p-3 text-center text-xs font-bold text-slate-500">${t.end?t.end.split('-').reverse().join('/'):'-'}</td>
                        <td class="p-3"><input value="${predVal}" onkeydown="editor.handleEnter(event, ${vIdx}, 5)" onchange="editor.updPred('${t.uuid}',this.value)" class="input-cell text-center font-bold text-blue-600" ${t.type==='item'?'':'disabled'}></td>
                        <td class="p-3 text-center"><button onclick="editor.remove('${t.uuid}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    </tr>`;
                    vIdx++;
                });
                lucide.createIcons();
            },

            upd(uuid, f, v) { const t = this.db.find(x => x.uuid === uuid); t[f] = v; this.recalc(); },
            updPred(uuid, v) { 
                const t = this.db.find(x => x.uuid === uuid);
                t.pred = v.split(',').map(n => this.indexMap[parseInt(n.trim())]).filter(Boolean);
                this.recalc();
            },
            addGroup() { this.db.push({uuid:'g'+Date.now(), name:'ETAPA', type:'group', parent:'m', cost:0, progress:0}); this.recalc(); },
            addItem(p) { this.db.push({uuid:'t'+Date.now(), name:'Atividade', type:'item', parent:p, cost:0, progress:0, duration:5, pred:[]}); this.collapsed.delete(p); this.recalc(); },
            remove(u) { if(u!=='m') { this.db = this.db.filter(x => x.uuid !== u && x.parent !== u); this.recalc(); } },
            toggle(uuid) { this.collapsed.has(uuid) ? this.collapsed.delete(uuid) : this.collapsed.add(uuid); this.renderTable(); },
            toggleAll(exp) { if(exp) this.collapsed.clear(); else this.db.filter(t => t.type === 'group').forEach(g => this.collapsed.add(g.uuid)); this.renderTable(); },

            switch(view) {
                document.querySelectorAll('.editor-view').forEach(v => v.classList.add('hidden'));
                document.getElementById('view-'+view).classList.remove('hidden');
                if(view === 'dash') this.renderDash();
            },

            renderDash() {
                const m = this.db.find(x => x.type === 'master');
                const costDone = this.db.filter(t=>t.type==='item').reduce((s,t)=> s + ((t.cost||0)*(t.progress/100)),0);
                
                document.getElementById('dash-kpis').innerHTML = `
                    <div class="kpi-card text-center"><p class="text-[10px] font-black text-slate-400 uppercase">Físico Total</p><h2 class="text-4xl font-black text-blue-600">${m.progress}%</h2></div>
                    <div class="kpi-card text-center"><p class="text-[10px] font-black text-slate-400 uppercase">Orçado</p><h2 class="text-2xl font-black text-slate-800">R$ ${m.cost.toLocaleString()}</h2></div>
                    <div class="kpi-card text-center"><p class="text-[10px] font-black text-slate-400 uppercase">Executado</p><h2 class="text-2xl font-black text-emerald-500">R$ ${costDone.toLocaleString()}</h2></div>
                    <div class="kpi-card text-center bg-slate-900 text-white border-none"><p class="text-[10px] font-black text-slate-500 uppercase">Saldo</p><h2 class="text-2xl font-black">R$ ${(m.cost - costDone).toLocaleString()}</h2></div>
                `;

                const ctx = document.getElementById('scurve-canvas').getContext('2d');
                if(window.sChart) window.sChart.destroy();
                window.sChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: ['Início','Hoje','Fim'], datasets: [{ label: 'Evolução Meta', data: [0, costDone, m.cost], borderColor: '#3b82f6', tension: 0.4 }] }
                });

                document.getElementById('dash-status-text').innerHTML = `
                    <div class="space-y-4">
                        <p class="text-xs text-slate-400">Entrega: <b class="text-white">${m.end || 'N/A'}</b></p>
                        <p class="text-xs text-slate-400">Status Financeiro: <b class="text-blue-400">Dentro do Orçado</b></p>
                    </div>
                `;
            },

            autoSave() {
                const idx = projectManager.projects.findIndex(x => x.id === this.currId);
                if(idx !== -1) {
                    projectManager.projects[idx].data = this.db;
                    projectManager.projects[idx].progress = this.db.find(x => x.type==='master').progress;
                    cloud.push(); // Salva na nuvem a cada alteração
                }
            }
        };

        window.onload = () => {
            const savedUrl = localStorage.getItem('bravo_fb_url');
            if(savedUrl) document.getElementById('fb-url').value = savedUrl;
        };
    </script>
</body>
</html>