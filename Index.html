<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner PRO v15 - Gestão Administrativa</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #2c3e50; --accent: #0984e3; --bg: #f5f6fa; --white: #ffffff; 
            --danger: #d63031; --success: #00b894; --warning: #fdcb6e; --text: #2d3436;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); }
        
        /* Sidebar */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10; }
        .brand { padding: 25px; font-size: 1.2rem; font-weight: 800; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content: space-between; }
        .save-indicator { font-size: 0.7rem; color: #00b894; opacity: 0; transition: opacity 0.5s; }
        
        .nav-category { padding: 25px 25px 10px; font-size: 0.75rem; text-transform: uppercase; color: #b2bec3; font-weight: 700; letter-spacing: 1px; }
        .nav-btn { padding: 12px 25px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; color: #dfe6e9; border-left: 4px solid transparent; font-size: 0.95rem; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); padding-left: 30px; }
        .nav-btn.active { background: rgba(255,255,255,0.1); color: white; border-left-color: var(--accent); font-weight: 600; }

        /* Main Area */
        main { flex: 1; padding: 30px; overflow-y: auto; scroll-behavior: smooth; }
        .screen { display: none; animation: fadeIn 0.4s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid rgba(0,0,0,0.02); }
        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; margin-bottom: 25px; font-weight: 700; display: flex; align-items: center; gap: 10px; }

        /* Inputs */
        .form-row { display: flex; gap: 20px; align-items: end; margin-bottom: 20px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        label { display: block; font-size: 0.8rem; color: #636e72; margin-bottom: 6px; font-weight: 700; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; border: 1px solid #b2bec3; border-radius: 6px; box-sizing: border-box; }
        
        /* Buttons */
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background: var(--accent); color: white; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { background: #b2bec3; cursor: not-allowed; }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); color: #2d3436; }

        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f2f6; padding: 10px; text-align: left; font-size: 0.8rem; color: #636e72; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .team-card { background: white; border: 1px solid #dfe6e9; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-top: 4px solid var(--accent); }
        .member-badge { background: #f1f2f6; color: #2d3436; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px solid #e1e8ed; display: inline-block; margin: 2px; }

        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .kpi-box { background: white; padding: 20px; border-radius: 10px; text-align: center; border-bottom: 4px solid #ccc; }
        .kpi-val { font-size: 2rem; font-weight: 800; color: var(--primary); }

        /* Alert */
        .alert-box { padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        .alert-danger { background: #ff7675; color: white; }
        .alert-success { background: #55efc4; color: #006266; }
        .alert-info { background: #74b9ff; color: #fff; }

        .type-tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase; font-weight: bold; }
        .type-prod { background: #a29bfe; color: white; }
        .type-adm { background: #00b894; color: white; }
    </style>
</head>
<body>

<aside>
    <div class="brand">
        <span><i class="fas fa-hard-hat"></i> PLANNER v15</span>
        <div class="save-indicator" id="save-status"><i class="fas fa-save"></i></div>
    </div>
    
    <div class="nav-category">Gerencial</div>
    <div class="nav-btn active" onclick="nav('dash', this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
    <div class="nav-btn" onclick="nav('schedule', this)"><i class="fas fa-calendar-alt"></i> Cronograma</div>
    
    <div class="nav-category">Cadastros</div>
    <div class="nav-btn" onclick="nav('services', this)"><i class="fas fa-cubes"></i> Serviços (Novo)</div>
    <div class="nav-btn" onclick="nav('teams', this)"><i class="fas fa-users"></i> Equipes</div>
    <div class="nav-btn" onclick="nav('resources', this)"><i class="fas fa-id-card"></i> Cargos</div>
    <div class="nav-btn" onclick="nav('productivity', this)"><i class="fas fa-stopwatch"></i> Produtividade</div>

    <div style="margin-top:auto; padding:20px;">
        <button class="btn btn-danger" style="width:100%; font-size:0.8rem;" onclick="resetData()">Resetar Sistema</button>
    </div>
</aside>

<main>

    <div id="dash" class="screen active">
        <h2>Dashboard Geral</h2>
        <div class="kpi-row">
            <div class="kpi-box" style="border-bottom-color: var(--primary);">
                <div class="kpi-val" id="kpi-cost">R$ 0</div>
                <div style="font-size:0.8rem; color:#666">Custo Total (MO)</div>
            </div>
            <div class="kpi-box" style="border-bottom-color: var(--warning);">
                <div class="kpi-val" id="kpi-peak">0</div>
                <div style="font-size:0.8rem; color:#666">Pico de Pessoas</div>
            </div>
            <div class="kpi-box" style="border-bottom-color: var(--success);">
                <div class="kpi-val" id="kpi-tasks">0</div>
                <div style="font-size:0.8rem; color:#666">Tarefas Ativas</div>
            </div>
        </div>
        <div class="card">
            <h3>Fluxo de Caixa Mensal</h3>
            <div id="chart-finance-stack" style="height:400px;"></div>
        </div>
        <div class="card">
            <h3>Histograma de Equipe</h3>
            <div id="chart-manpower-stack" style="height:350px;"></div>
        </div>
        <button class="btn" style="width:100%" onclick="calcDash()">Atualizar Dados</button>
    </div>

    <div id="services" class="screen">
        <div class="card">
            <h2>Banco de Serviços</h2>
            <div class="form-row" style="background:#f8f9fa; padding:20px; border-radius:10px;">
                <div class="form-group" style="flex:2">
                    <label>Nome do Serviço</label>
                    <input type="text" id="svc-name" placeholder="Ex: Gestão da Obra ou Alvenaria">
                </div>
                <div class="form-group">
                    <label>Tipo de Controle</label>
                    <select id="svc-type">
                        <option value="prod">Produção (m², m³, un)</option>
                        <option value="adm">Administrativo (Tempo)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Unidade</label>
                    <input type="text" id="svc-unit" placeholder="m² ou mês">
                </div>
                <div class="form-group" style="flex:0">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="addSvc()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <table style="width:100%">
                <thead><tr><th>Serviço</th><th>Tipo</th><th>Unidade</th><th>Ação</th></tr></thead>
                <tbody id="svc-list-table"></tbody>
            </table>
        </div>
    </div>

    <div id="schedule" class="screen">
        <div class="card">
            <h2>Cronograma Executivo</h2>
            <div style="background:#f8f9fa; padding:25px; border-radius:10px; border:1px solid #e1e8ed; margin-bottom:30px;">
                <div class="form-row">
                    <div class="form-group" style="flex:2"><label>Descrição</label><input type="text" id="t-desc" placeholder="Ex: Engenheiro Residente"></div>
                    <div class="form-group"><label>Serviço</label><select id="t-svc" onchange="validate()"></select></div>
                    <div class="form-group"><label>Equipe</label><select id="t-team" onchange="validate()"></select></div>
                    <div class="form-group"><label>Quantidade</label><input type="number" id="t-qtd" placeholder="0" oninput="validate()"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Início</label><input type="date" id="t-start" onchange="validate()"></div>
                    <div class="form-group"><label>Fim</label><input type="date" id="t-end" onchange="validate()"></div>
                    <div class="form-group" style="flex:2"><label>Validação</label><input type="text" id="t-status" readonly style="font-weight:bold; background:#e1e8ed;"></div>
                </div>
                <div id="alert-box" class="alert-box"></div>
                <button id="btn-add" class="btn" style="width:100%; margin-top:15px;" disabled onclick="addTask()">+ Adicionar Tarefa</button>
            </div>
            <h3>Tarefas</h3>
            <div id="task-list-visual"></div>
        </div>
    </div>

    <div id="teams" class="screen">
        <div class="card">
            <h2>Equipes</h2>
            <div class="form-row" style="background:#f8f9fa; padding:20px; border-radius:10px;">
                <div class="form-group"><label>Nova Equipe</label><input type="text" id="team-name" placeholder="Ex: Equipe Engenharia"></div>
                <div class="form-group" style="flex:0"><label>&nbsp;</label><button class="btn" onclick="createTeam()">Criar</button></div>
            </div>
            <div id="edit-box" style="display:none; border:2px dashed #fdcb6e; padding:20px; border-radius:10px; margin-bottom:20px;">
                <h3>Editar Equipe</h3>
                <input type="hidden" id="edit-id">
                <div class="form-row">
                    <input id="edit-name-input" placeholder="Nome">
                    <select id="edit-res-sel"></select>
                    <input type="number" id="edit-res-qty" value="1" style="width:80px">
                    <button class="btn btn-warning" onclick="addMemEdit()">Add</button>
                </div>
                <div id="edit-list" style="margin-bottom:10px;"></div>
                <button class="btn btn-success" onclick="saveEdit()">Salvar</button>
                <button class="btn btn-danger" onclick="cancelEdit()">Cancelar</button>
            </div>
            <div id="teams-grid" class="team-grid"></div>
        </div>
    </div>

    <div id="resources" class="screen">
        <div class="card"><h2>Cargos</h2>
            <div class="form-row"><input type="text" id="res-name" placeholder="Cargo"><select id="res-type"><option value="operacional">Operacional</option><option value="adm">ADM</option></select><input type="number" id="res-cost" placeholder="Custo"><button class="btn" onclick="addRes()">Salvar</button></div>
            <div id="res-list"></div>
        </div>
    </div>
    <div id="productivity" class="screen">
        <div class="card"><h2>Matriz Produtividade</h2><div style="overflow-x:auto"><table id="prod-table"></table></div><button class="btn btn-success" style="margin-top:20px" onclick="save()">Salvar</button></div>
    </div>

</main>

<script>
    // --- DADOS INICIAIS ---
    let db = {
        // Agora svc tem a propriedade 'type'
        svc: JSON.parse(localStorage.getItem('p15_svc')) || [
            {id:1, name:'Alvenaria', type:'prod', unit:'m²'},
            {id:2, name:'Engenharia', type:'adm', unit:'mes'} 
        ],
        res: JSON.parse(localStorage.getItem('p15_res')) || [{id:1, name:'Pedreiro', type:'operacional', cost:3500}, {id:2, name:'Engenheiro', type:'adm', cost:12000}],
        prod: JSON.parse(localStorage.getItem('p15_prod')) || {1:{1:15}}, 
        teams: JSON.parse(localStorage.getItem('p15_teams')) || [{id:1, name:'Eq. Obra', members:[{resId:1, qty:2}]}, {id:2, name:'Eq. Eng', members:[{resId:2, qty:1}]}],
        tasks: JSON.parse(localStorage.getItem('p15_tasks')) || []
    };

    function save() {
        localStorage.setItem('p15_svc', JSON.stringify(db.svc));
        localStorage.setItem('p15_res', JSON.stringify(db.res));
        localStorage.setItem('p15_prod', JSON.stringify(db.prod));
        localStorage.setItem('p15_teams', JSON.stringify(db.teams));
        localStorage.setItem('p15_tasks', JSON.stringify(db.tasks));
        const status = document.getElementById('save-status');
        status.style.opacity = '1'; setTimeout(() => status.style.opacity = '0', 1000);
        renderAll();
    }
    
    function resetData() { if(confirm("Resetar?")) { localStorage.clear(); location.reload(); } }
    
    function nav(screenId, btn) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if(btn) btn.classList.add('active');
        if(screenId === 'dash') setTimeout(calcDash, 100);
        if(screenId === 'productivity') renderProd();
        if(screenId === 'schedule') renderTasksVisual();
        updateSelects();
    }

    // --- ABA SERVIÇOS ---
    function addSvc() {
        let name = document.getElementById('svc-name').value;
        let type = document.getElementById('svc-type').value;
        let unit = document.getElementById('svc-unit').value;
        if(name && unit) {
            db.svc.push({id:Date.now(), name, type, unit});
            save(); document.getElementById('svc-name').value = '';
        }
    }

    function renderServicesTable() {
        document.getElementById('svc-list-table').innerHTML = db.svc.map(s => `
            <tr>
                <td><strong>${s.name}</strong></td>
                <td><span class="type-tag ${s.type==='prod'?'type-prod':'type-adm'}">${s.type==='prod'?'Produção':'Administrativo'}</span></td>
                <td>${s.unit}</td>
                <td style="text-align:center"><button class="btn btn-danger" style="padding:5px" onclick="delSvc(${s.id})"><i class="fas fa-trash"></i></button></td>
            </tr>
        `).join('');
    }
    function delSvc(id) { db.svc = db.svc.filter(s => s.id !== id); save(); }

    // --- VALIDAÇÃO (O GRANDE TRUQUE) ---
    function countBusinessDays(s,e){ let c=0; let d=new Date(s); let z=new Date(e); while(d<=z){ let w=d.getDay(); if(w!==0&&w!==6)c++; d.setDate(d.getDate()+1); } return c; }

    function validate() {
        const svcId=document.getElementById('t-svc').value, teamId=document.getElementById('t-team').value, qtdVal=document.getElementById('t-qtd').value, start=document.getElementById('t-start').value, end=document.getElementById('t-end').value;
        const btn=document.getElementById('btn-add'), alertBox=document.getElementById('alert-box'), status=document.getElementById('t-status');
        btn.disabled=true; alertBox.style.display='none'; status.value="";

        if(!svcId||!teamId||!start||!end){status.value="...";return;}
        if(new Date(end)<new Date(start)){status.value="Datas Inválidas";return;}

        let svc = db.svc.find(x => x.id == svcId);
        
        // ** NOVA LÓGICA DE BYPASS **
        if(svc.type === 'adm') {
            // Serviço Administrativo: Ignora produtividade e quantidade
            status.value = "VIÁVEL (Administrativo)";
            status.style.color = "blue";
            alertBox.style.display='block'; 
            alertBox.className='alert-box alert-info'; 
            alertBox.innerHTML=`<strong>${svc.name}:</strong> Tarefa baseada em tempo. Cálculo de produtividade ignorado.`;
            btn.disabled = false;
            return; // Sai da função, liberando o botão
        }

        // Se for Produção, continua a validação rigorosa
        if(!qtdVal) { status.value="Qtd?"; return; }
        
        let team=db.teams.find(x=>x.id==teamId); let dailyCap=0;
        team.members.forEach(m=>{ let r=db.res.find(rx=>rx.id==m.resId); if(r&&r.type!=='adm'){ let p=(db.prod[m.resId]&&db.prod[m.resId][svcId])||0; dailyCap+=p*m.qty; } });

        if(dailyCap===0){status.value="Sem Produtividade"; alertBox.style.display='block'; alertBox.className='alert-box alert-danger'; alertBox.innerHTML="Equipe não produtiva."; return;}

        let daysNeeded=Math.ceil(qtdVal/dailyCap); let daysAvailable=countBusinessDays(start+'T00:00:00',end+'T00:00:00'); 
        
        if(daysNeeded>daysAvailable){ 
            status.value="ATRASO"; alertBox.style.display='block'; alertBox.className='alert-box alert-danger'; alertBox.innerHTML=`Falta Prazo. Necessário: ${daysNeeded} dias. Disp: ${daysAvailable} dias.`; 
        } else { 
            status.value="VIÁVEL"; alertBox.style.display='block'; alertBox.className='alert-box alert-success'; alertBox.innerHTML=`OK. Folga: ${daysAvailable-daysNeeded} dias.`; btn.disabled=false; 
        }
    }

    function addTask() {
        db.tasks.push({
            id:Date.now(), desc:document.getElementById('t-desc').value, svcId:document.getElementById('t-svc').value, teamId:document.getElementById('t-team').value, qtd:document.getElementById('t-qtd').value || 1, start:document.getElementById('t-start').value, end:document.getElementById('t-end').value
        });
        save(); document.getElementById('t-desc').value=''; renderTasksVisual();
    }
    
    function delTask(id){ db.tasks=db.tasks.filter(t=>t.id!==id); save(); renderTasksVisual(); }
    function renderTasksVisual(){ const c=document.getElementById('task-list-visual'); if(db.tasks.length===0){c.innerHTML="<p style='text-align:center; color:#999'>Vazio</p>";return;} c.innerHTML=db.tasks.map(t=>{ let tm=db.teams.find(x=>x.id==t.teamId); let svc=db.svc.find(x=>x.id==t.svcId); return `<div class="team-card" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><div><strong>${t.desc}</strong><br><small>${svc?svc.name:'?'} | ${tm?tm.name:'?'}</small></div><button class="btn btn-danger" onclick="delTask(${t.id})"><i class="fas fa-trash"></i></button></div>`}).join(''); }

    // --- ABA EQUIPES ---
    function renderTeamsCards() {
        document.getElementById('teams-grid').innerHTML = db.teams.map(t => {
            let cost=0; let count=0;
            let mems = t.members.map(m => {
                let r=db.res.find(x=>x.id==m.resId);
                if(r) { cost+=r.cost*m.qty; count+=m.qty; return `<span class="member-badge">${m.qty}x ${r.name}</span>`; }
            }).join('');
            return `<div class="team-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><strong>${t.name}</strong><span style="background:#eee; padding:2px 8px; border-radius:10px; font-size:0.8rem">${count} <i class="fas fa-user"></i></span></div>
                <div style="margin-bottom:10px;">${mems||'-'}</div>
                <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; padding-top:10px;">
                    <div style="color:green; font-weight:bold">R$ ${cost.toLocaleString('pt-BR')}</div>
                    <button class="btn btn-warning" style="padding:4px 10px; font-size:0.8rem" onclick="editTeam(${t.id})">Edit</button>
                </div>
            </div>`;
        }).join('');
    }
    // Edit Logic
    function createTeam(){ db.teams.push({id:Date.now(), name:document.getElementById('team-name').value, members:[]}); save(); document.getElementById('team-name').value=''; }
    function editTeam(id){ document.getElementById('edit-box').style.display='block'; let t=db.teams.find(x=>x.id==id); document.getElementById('edit-id').value=t.id; document.getElementById('edit-name-input').value=t.name; renderMemEdit(t); document.getElementById('edit-res-sel').innerHTML=db.res.map(r=>`<option value="${r.id}">${r.name}</option>`).join(''); }
    function renderMemEdit(t){ document.getElementById('edit-list').innerHTML=t.members.map((m,i)=>{ let r=db.res.find(x=>x.id==m.resId); return `<span class="member-badge">${m.qty}x ${r?r.name:'?'} <i class="fas fa-times" onclick="remMem(${i})" style="color:red;cursor:pointer"></i></span>` }).join(''); }
    function addMemEdit(){ let t=db.teams.find(x=>x.id==document.getElementById('edit-id').value); t.members.push({resId:parseInt(document.getElementById('edit-res-sel').value), qty:parseInt(document.getElementById('edit-res-qty').value)}); renderMemEdit(t); }
    function remMem(i){ let t=db.teams.find(x=>x.id==document.getElementById('edit-id').value); t.members.splice(i,1); renderMemEdit(t); }
    function saveEdit(){ let t=db.teams.find(x=>x.id==document.getElementById('edit-id').value); t.name=document.getElementById('edit-name-input').value; save(); cancelEdit(); }
    function cancelEdit(){ document.getElementById('edit-box').style.display='none'; }

    // --- DASHBOARD ---
    function calcDash() {
        if(db.tasks.length===0){ document.getElementById('chart-manpower-stack').innerHTML="Vazio"; return; }
        let dMin = new Date(db.tasks[0].start); let dMax = new Date(db.tasks[0].end);
        db.tasks.forEach(t=>{ if(new Date(t.start)<dMin)dMin=new Date(t.start); if(new Date(t.end)>dMax)dMax=new Date(t.end); });
        let months=[]; let curr=new Date(dMin.getFullYear(), dMin.getMonth(), 1); let end=new Date(dMax.getFullYear(), dMax.getMonth()+1, 0);
        while(curr<=end){ months.push(new Date(curr)); curr.setMonth(curr.getMonth()+1); }
        let labels=months.map(d=>d.toLocaleString('pt-BR',{month:'short', year:'2-digit'}));

        let teamStack={}; let serviceStack={};
        db.teams.forEach(t=>teamStack[t.name]=new Array(months.length).fill(0));
        db.svc.forEach(s=>serviceStack[s.name]=new Array(months.length).fill(0));

        let totalLabor=0;
        db.tasks.forEach(t=>{
            let tS=new Date(t.start); let tE=new Date(t.end);
            let team=db.teams.find(x=>x.id==t.teamId); let svc=db.svc.find(x=>x.id==t.svcId);
            if(!team||!svc)return;
            let costM=team.members.reduce((a,m)=>{let r=db.res.find(x=>x.id==m.resId); return a+(r?r.cost*m.qty:0)},0);
            let sizeM=team.members.reduce((a,m)=>a+m.qty,0);
            months.forEach((mDate,i)=>{
                let mS=new Date(mDate.getFullYear(), mDate.getMonth(), 1); let mE=new Date(mDate.getFullYear(), mDate.getMonth()+1, 0);
                if(tS<=mE && tE>=mS){ teamStack[team.name][i]+=sizeM; serviceStack[svc.name][i]+=costM; totalLabor+=costM; }
            });
        });

        document.getElementById('kpi-cost').innerText="R$ "+totalLabor.toLocaleString('pt-BR',{maximumFractionDigits:0});
        let moArr=new Array(months.length).fill(0); for(let k in teamStack)teamStack[k].forEach((v,i)=>moArr[i]+=v);
        document.getElementById('kpi-peak').innerText=Math.max(...moArr);
        document.getElementById('kpi-tasks').innerText=db.tasks.length;

        let tracesMO=[]; for(let tm in teamStack) tracesMO.push({x:labels, y:teamStack[tm], name:tm, type:'bar'});
        Plotly.newPlot('chart-manpower-stack', tracesMO, {barmode:'stack', margin:{t:30,b:30}});
        let tracesFin=[]; for(let s in serviceStack) tracesFin.push({x:labels, y:serviceStack[s], name:s, type:'bar'});
        Plotly.newPlot('chart-finance-stack', tracesFin, {barmode:'stack', margin:{t:30,b:30}});
    }

    // --- APOIO ---
    function addRes(){ db.res.push({id:Date.now(), name:document.getElementById('res-name').value, type:document.getElementById('res-type').value, cost:parseFloat(document.getElementById('res-cost').value)}); save(); document.getElementById('res-name').value=''; }
    function renderProd(){ let h=`<thead><tr><th>Cargo</th>${db.svc.map(s=>`<th>${s.name}</th>`).join('')}</tr></thead><tbody>`; db.res.forEach(r=>{ let isAdm=r.type==='adm'; h+=`<tr style="${isAdm?'background:#f9f9f9':''}"><td>${r.name}</td>`; db.svc.forEach(s=>{ if(s.type==='adm'||isAdm) h+=`<td style="background:#eee">-</td>`; else { let v=(db.prod[r.id]&&db.prod[r.id][s.id])||0; h+=`<td><input type="number" style="width:60px" value="${v}" onchange="if(!db.prod[${r.id}])db.prod[${r.id}]={};db.prod[${r.id}][${s.id}]=parseFloat(this.value)"></td>`; } }); h+='</tr>'; }); document.getElementById('prod-table').innerHTML=h+'</tbody>'; }
    function updateSelects(){ const f=(id,l)=>document.getElementById(id).innerHTML='<option value="">...</option>'+l.map(i=>`<option value="${i.id}">${i.name}</option>`).join(''); f('t-svc',db.svc); f('t-team',db.teams); }
    function renderAll(){ renderServicesTable(); renderTeamsCards(); document.getElementById('res-list').innerHTML=db.res.map(s=>`<div style="padding:5px;border-bottom:1px solid #eee"><b>${s.name}</b> (${s.type})</div>`).join(''); renderTasksVisual(); updateSelects(); }

    renderAll(); setTimeout(calcDash, 500);
</script>
</body>
</html>